// UniversalbankCRM.sln

Microsoft Visual Studio Solution File, Format Version 12.00
# Visual Studio Version 17
VisualStudioVersion = 17.0.31903.59
MinimumVisualStudioVersion = 10.0.40219.1
Project("{2150E333-8FDC-42A3-9474-1A3956D46DE8}") = "src", "src", "{4F55484D-ECBE-4257-8E45-54B8C8F1C0E5}"
EndProject
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "UniversalbankCRM.Domain", "src\UniversalbankCRM.Domain\UniversalbankCRM.Domain.csproj", "{55B2E2B5-AB8B-46DE-8E13-60F1EAD1ABFC}"
EndProject
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "UniversalbankCRM.Application", "src\UniversalbankCRM.Application\UniversalbankCRM.Application.csproj", "{61E22F41-7878-482C-A7F3-9A2FBA5A07EC}"
EndProject
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "UniversalbankCRM.Infrastructure", "src\UniversalbankCRM.Infrastructure\UniversalbankCRM.Infrastructure.csproj", "{F7CE2C4D-9C38-4D6D-9F5C-8BB0F4EED13D}"
EndProject
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "UniversalbankCRM.WebApi", "src\UniversalbankCRM.WebApi\UniversalbankCRM.WebApi.csproj", "{B8D56C1A-88CF-43BC-B4E0-2F76E3113ECA}"
EndProject
Project("{FAE04EC0-301F-11D3-BF4B-00C04F79EFBC}") = "UniversalbankCRM.Blazor", "src\UniversalbankCRM.Blazor\UniversalbankCRM.Blazor.csproj", "{D53C5825-4F8F-48A0-A9E4-2DBF9C3F2AA9}"
EndProject
Global
	GlobalSection(SolutionConfigurationPlatforms) = preSolution
		Debug|Any CPU = Debug|Any CPU
		Release|Any CPU = Release|Any CPU
	EndGlobalSection
	GlobalSection(SolutionProperties) = preSolution
		HideSolutionNode = FALSE
	EndGlobalSection
	GlobalSection(ProjectConfigurationPlatforms) = postSolution
		{55B2E2B5-AB8B-46DE-8E13-60F1EAD1ABFC}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{55B2E2B5-AB8B-46DE-8E13-60F1EAD1ABFC}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{55B2E2B5-AB8B-46DE-8E13-60F1EAD1ABFC}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{55B2E2B5-AB8B-46DE-8E13-60F1EAD1ABFC}.Release|Any CPU.Build.0 = Release|Any CPU
		{61E22F41-7878-482C-A7F3-9A2FBA5A07EC}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{61E22F41-7878-482C-A7F3-9A2FBA5A07EC}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{61E22F41-7878-482C-A7F3-9A2FBA5A07EC}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{61E22F41-7878-482C-A7F3-9A2FBA5A07EC}.Release|Any CPU.Build.0 = Release|Any CPU
		{F7CE2C4D-9C38-4D6D-9F5C-8BB0F4EED13D}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{F7CE2C4D-9C38-4D6D-9F5C-8BB0F4EED13D}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{F7CE2C4D-9C38-4D6D-9F5C-8BB0F4EED13D}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{F7CE2C4D-9C38-4D6D-9F5C-8BB0F4EED13D}.Release|Any CPU.Build.0 = Release|Any CPU
		{B8D56C1A-88CF-43BC-B4E0-2F76E3113ECA}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{B8D56C1A-88CF-43BC-B4E0-2F76E3113ECA}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{B8D56C1A-88CF-43BC-B4E0-2F76E3113ECA}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{B8D56C1A-88CF-43BC-B4E0-2F76E3113ECA}.Release|Any CPU.Build.0 = Release|Any CPU
		{D53C5825-4F8F-48A0-A9E4-2DBF9C3F2AA9}.Debug|Any CPU.ActiveCfg = Debug|Any CPU
		{D53C5825-4F8F-48A0-A9E4-2DBF9C3F2AA9}.Debug|Any CPU.Build.0 = Debug|Any CPU
		{D53C5825-4F8F-48A0-A9E4-2DBF9C3F2AA9}.Release|Any CPU.ActiveCfg = Release|Any CPU
		{D53C5825-4F8F-48A0-A9E4-2DBF9C3F2AA9}.Release|Any CPU.Build.0 = Release|Any CPU
	EndGlobalSection
	GlobalSection(NestedProjects) = preSolution
		{55B2E2B5-AB8B-46DE-8E13-60F1EAD1ABFC} = {4F55484D-ECBE-4257-8E45-54B8C8F1C0E5}
		{61E22F41-7878-482C-A7F3-9A2FBA5A07EC} = {4F55484D-ECBE-4257-8E45-54B8C8F1C0E5}
		{F7CE2C4D-9C38-4D6D-9F5C-8BB0F4EED13D} = {4F55484D-ECBE-4257-8E45-54B8C8F1C0E5}
		{B8D56C1A-88CF-43BC-B4E0-2F76E3113ECA} = {4F55484D-ECBE-4257-8E45-54B8C8F1C0E5}
		{D53C5825-4F8F-48A0-A9E4-2DBF9C3F2AA9} = {4F55484D-ECBE-4257-8E45-54B8C8F1C0E5}
	EndGlobalSection
EndGlobal

// src/UniversalbankCRM.Domain/UniversalbankCRM.Domain.csproj
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
  </PropertyGroup>

</Project>

// src/UniversalbankCRM.Domain/Common/EntityBase.cs
namespace UniversalbankCRM.Domain.Common;

public abstract class EntityBase
{
    public Guid Id { get; set; }
    public DateTime CreatedAt { get; set; }
    public string? CreatedBy { get; set; }
    public DateTime? LastModifiedAt { get; set; }
    public string? LastModifiedBy { get; set; }
    public bool IsDeleted { get; set; }
}

// src/UniversalbankCRM.Domain/Entities/Customer.cs
namespace UniversalbankCRM.Domain.Entities;

using UniversalbankCRM.Domain.Common;
using UniversalbankCRM.Domain.Enums;

public class Customer : EntityBase
{
    public CustomerType Type { get; set; }
    public string Name { get; set; } = string.Empty;
    public string? TaxId { get; set; } // СТИР/ЖШШИР
    public string? Email { get; set; }
    public string? Phone { get; set; }
    public string? Address { get; set; }
    public string? ContactPerson { get; set; } // For juridical person
    public DateTime? DateOfBirth { get; set; } // For individual
    public string? PassportData { get; set; } // For individual
    public CustomerSegment Segment { get; set; }
    public CustomerStatus Status { get; set; }
    public string? Notes { get; set; }
    
    // Navigation properties
    public ICollection<Interaction> Interactions { get; set; } = new List<Interaction>();
    public ICollection<Deal> Deals { get; set; } = new List<Deal>();
    public ICollection<SupportTicket> SupportTickets { get; set; } = new List<SupportTicket>();
}

// src/UniversalbankCRM.Domain/Entities/Interaction.cs
namespace UniversalbankCRM.Domain.Entities;

using UniversalbankCRM.Domain.Common;
using UniversalbankCRM.Domain.Enums;

public class Interaction : EntityBase
{
    public Guid CustomerId { get; set; }
    public Customer Customer { get; set; } = null!;
    public InteractionType Type { get; set; }
    public string Subject { get; set; } = string.Empty;
    public string Description { get; set; } = string.Empty;
    public DateTime InteractionDate { get; set; }
    public InteractionDirection Direction { get; set; }
    public InteractionStatus Status { get; set; }
    public Guid? AssignedToUserId { get; set; }
    public DateTime? FollowUpDate { get; set; }
}

// src/UniversalbankCRM.Domain/Entities/Deal.cs
namespace UniversalbankCRM.Domain.Entities;

using UniversalbankCRM.Domain.Common;
using UniversalbankCRM.Domain.Enums;

public class Deal : EntityBase
{
    public string Title { get; set; } = string.Empty;
    public Guid CustomerId { get; set; }
    public Customer Customer { get; set; } = null!;
    public Guid? AssignedToUserId { get; set; }
    public decimal Value { get; set; }
    public string Description { get; set; } = string.Empty;
    public DealStage Stage { get; set; }
    public int SuccessProbability { get; set; } // Percentage 0-100
    public DateTime? ExpectedCloseDate { get; set; }
    public string? Source { get; set; }
    public DealStatus Status { get; set; }
    public string? Notes { get; set; }
    
    // Navigation properties
    public ICollection<Task> Tasks { get; set; } = new List<Task>();
}

// src/UniversalbankCRM.Domain/Entities/Task.cs
namespace UniversalbankCRM.Domain.Entities;

using UniversalbankCRM.Domain.Common;
using UniversalbankCRM.Domain.Enums;

public class Task : EntityBase
{
    public string Title { get; set; } = string.Empty;
    public string Description { get; set; } = string.Empty;
    public Guid? CustomerId { get; set; }
    public Customer? Customer { get; set; }
    public Guid? DealId { get; set; }
    public Deal? Deal { get; set; }
    public TaskPriority Priority { get; set; }
    public TaskStatus Status { get; set; }
    public DateTime? DueDate { get; set; }
    public Guid? AssignedToUserId { get; set; }
    public string? Notes { get; set; }
}

// src/UniversalbankCRM.Domain/Entities/SupportTicket.cs
namespace UniversalbankCRM.Domain.Entities;

using UniversalbankCRM.Domain.Common;
using UniversalbankCRM.Domain.Enums;

public class SupportTicket : EntityBase
{
    public string Title { get; set; } = string.Empty;
    public string Description { get; set; } = string.Empty;
    public Guid CustomerId { get; set; }
    public Customer Customer { get; set; } = null!;
    public SupportTicketStatus Status { get; set; }
    public SupportTicketPriority Priority { get; set; }
    public Guid? AssignedToUserId { get; set; }
    public DateTime? ResolvedAt { get; set; }
    public string? Resolution { get; set; }
    
    // Navigation properties
    public ICollection<SupportTicketComment> Comments { get; set; } = new List<SupportTicketComment>();
}

// src/UniversalbankCRM.Domain/Entities/SupportTicketComment.cs
namespace UniversalbankCRM.Domain.Entities;

using UniversalbankCRM.Domain.Common;

public class SupportTicketComment : EntityBase
{
    public Guid SupportTicketId { get; set; }
    public SupportTicket SupportTicket { get; set; } = null!;
    public string Text { get; set; } = string.Empty;
    public Guid UserId { get; set; }
    public bool IsInternal { get; set; } // Internal notes not visible to customer
}

// src/UniversalbankCRM.Domain/Entities/MarketingCampaign.cs
namespace UniversalbankCRM.Domain.Entities;

using UniversalbankCRM.Domain.Common;
using UniversalbankCRM.Domain.Enums;

public class MarketingCampaign : EntityBase
{
    public string Name { get; set; } = string.Empty;
    public string Description { get; set; } = string.Empty;
    public MarketingCampaignType Type { get; set; }
    public MarketingCampaignStatus Status { get; set; }
    public DateTime? StartDate { get; set; }
    public DateTime? EndDate { get; set; }
    public decimal Budget { get; set; }
    public string? TargetAudience { get; set; }
    public string? ExpectedOutcome { get; set; }
    public string? ActualOutcome { get; set; }
    
    // Navigation properties
    public ICollection<MarketingCampaignActivity> Activities { get; set; } = new List<MarketingCampaignActivity>();
}

// src/UniversalbankCRM.Domain/Entities/MarketingCampaignActivity.cs
namespace UniversalbankCRM.Domain.Entities;

using UniversalbankCRM.Domain.Common;
using UniversalbankCRM.Domain.Enums;

public class MarketingCampaignActivity : EntityBase
{
    public Guid MarketingCampaignId { get; set; }
    public MarketingCampaign MarketingCampaign { get; set; } = null!;
    public string Name { get; set; } = string.Empty;
    public string Description { get; set; } = string.Empty;
    public MarketingActivityType Type { get; set; }
    public MarketingActivityStatus Status { get; set; }
    public DateTime? ExecutionDate { get; set; }
    public decimal Cost { get; set; }
    public string? Result { get; set; }
}

// src/UniversalbankCRM.Domain/Entities/User.cs
namespace UniversalbankCRM.Domain.Entities;

using UniversalbankCRM.Domain.Common;
using UniversalbankCRM.Domain.Enums;

public class User : EntityBase
{
    public string Username { get; set; } = string.Empty;
    public string Email { get; set; } = string.Empty;
    public string PasswordHash { get; set; } = string.Empty;
    public string FirstName { get; set; } = string.Empty;
    public string LastName { get; set; } = string.Empty;
    public string? Position { get; set; }
    public string? Department { get; set; }
    public string? PhoneNumber { get; set; }
    public UserRole Role { get; set; }
    public UserStatus Status { get; set; }
    public DateTime? LastLoginDate { get; set; }
}

// src/UniversalbankCRM.Domain/Enums/CustomerType.cs
namespace UniversalbankCRM.Domain.Enums;

public enum CustomerType
{
    Individual = 1,
    Juridical = 2
}

// src/UniversalbankCRM.Domain/Enums/CustomerSegment.cs
namespace UniversalbankCRM.Domain.Enums;

public enum CustomerSegment
{
    Regular = 1,
    Premium = 2,
    VIP = 3,
    Corporate = 4,
    SME = 5
}

// src/UniversalbankCRM.Domain/Enums/CustomerStatus.cs
namespace UniversalbankCRM.Domain.Enums;

public enum CustomerStatus
{
    Active = 1,
    Inactive = 2,
    Prospect = 3,
    Former = 4,
    Blacklisted = 5
}

// src/UniversalbankCRM.Domain/Enums/InteractionType.cs
namespace UniversalbankCRM.Domain.Enums;

public enum InteractionType
{
    Call = 1,
    Email = 2,
    Meeting = 3,
    WebForm = 4,
    SocialMedia = 5,
    Chat = 6,
    Other = 7
}

// src/UniversalbankCRM.Domain/Enums/InteractionDirection.cs
namespace UniversalbankCRM.Domain.Enums;

public enum InteractionDirection
{
    Inbound = 1,
    Outbound = 2
}

// src/UniversalbankCRM.Domain/Enums/InteractionStatus.cs
namespace UniversalbankCRM.Domain.Enums;

public enum InteractionStatus
{
    Planned = 1,
    InProgress = 2,
    Completed = 3,
    Canceled = 4
}

// src/UniversalbankCRM.Domain/Enums/DealStage.cs
namespace UniversalbankCRM.Domain.Enums;

public enum DealStage
{
    Lead = 1,
    Qualified = 2,
    Proposal = 3,
    Negotiation = 4,
    ClosedWon = 5,
    ClosedLost = 6
}

// src/UniversalbankCRM.Domain/Enums/DealStatus.cs
namespace UniversalbankCRM.Domain.Enums;

public enum DealStatus
{
    Active = 1,
    OnHold = 2,
    Closed = 3,
    Canceled = 4
}

// src/UniversalbankCRM.Domain/Enums/TaskPriority.cs
namespace UniversalbankCRM.Domain.Enums;

public enum TaskPriority
{
    Low = 1,
    Medium = 2,
    High = 3,
    Critical = 4
}

// src/UniversalbankCRM.Domain/Enums/TaskStatus.cs
namespace UniversalbankCRM.Domain.Enums;

public enum TaskStatus
{
    New = 1,
    InProgress = 2,
    Completed = 3,
    Deferred = 4,
    Canceled = 5
}

// src/UniversalbankCRM.Domain/Enums/SupportTicketStatus.cs
namespace UniversalbankCRM.Domain.Enums;

public enum SupportTicketStatus
{
    New = 1,
    Assigned = 2,
    InProgress = 3,
    AwaitingCustomerResponse = 4,
    Resolved = 5,
    Closed = 6,
    Reopened = 7
}

// src/UniversalbankCRM.Domain/Enums/SupportTicketPriority.cs
namespace UniversalbankCRM.Domain.Enums;

public enum SupportTicketPriority
{
    Low = 1,
    Medium = 2,
    High = 3,
    Critical = 4
}

// src/UniversalbankCRM.Domain/Enums/MarketingCampaignType.cs
namespace UniversalbankCRM.Domain.Enums;

public enum MarketingCampaignType
{
    Email = 1,
    SMS = 2,
    Social = 3,
    Event = 4,
    Direct = 5,
    Web = 6,
    Other = 7
}

// src/UniversalbankCRM.Domain/Enums/MarketingCampaignStatus.cs
namespace UniversalbankCRM.Domain.Enums;

public enum MarketingCampaignStatus
{
    Draft = 1,
    Planned = 2,
    Active = 3,
    Paused = 4,
    Completed = 5,
    Canceled = 6
}

// src/UniversalbankCRM.Domain/Enums/MarketingActivityType.cs
namespace UniversalbankCRM.Domain.Enums;

public enum MarketingActivityType
{
    EmailCampaign = 1,
    SMSBlast = 2,
    SocialMediaPost = 3,
    EventOrganization = 4,
    DirectMailing = 5,
    WebAdvertising = 6,
    ContentCreation = 7,
    Other = 8
}

// src/UniversalbankCRM.Domain/Enums/MarketingActivityStatus.cs
namespace UniversalbankCRM.Domain.Enums;

public enum MarketingActivityStatus
{
    Planned = 1,
    InProgress = 2,
    Completed = 3,
    Canceled = 4
}

// src/UniversalbankCRM.Domain/Enums/UserRole.cs
namespace UniversalbankCRM.Domain.Enums;

public enum UserRole
{
    Administrator = 1,
    SalesManager = 2,
    MarketingManager = 3,
    SupportAgent = 4,
    BranchEmployee = 5,
    Executive = 6
}

// src/UniversalbankCRM.Domain/Enums/UserStatus.cs
namespace UniversalbankCRM.Domain.Enums;

public enum UserStatus
{
    Active = 1,
    Inactive = 2,
    Suspended = 3,
    Pending = 4
}

// src/UniversalbankCRM.Application/UniversalbankCRM.Application.csproj
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="AutoMapper" Version="12.0.1" />
    <PackageReference Include="AutoMapper.Extensions.Microsoft.DependencyInjection" Version="12.0.1" />
    <PackageReference Include="FluentValidation" Version="11.9.0" />
    <PackageReference Include="FluentValidation.DependencyInjectionExtensions" Version="11.9.0" />
    <PackageReference Include="MediatR" Version="12.2.0" />
    <PackageReference Include="Microsoft.Extensions.Logging.Abstractions" Version="8.0.0" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\UniversalbankCRM.Domain\UniversalbankCRM.Domain.csproj" />
  </ItemGroup>

</Project>

// src/UniversalbankCRM.Application/Common/Interfaces/IApplicationDbContext.cs
namespace UniversalbankCRM.Application.Common.Interfaces;

using Microsoft.EntityFrameworkCore;
using UniversalbankCRM.Domain.Entities;

public interface IApplicationDbContext
{
    DbSet<Customer> Customers { get; }
    DbSet<Interaction> Interactions { get; }
    DbSet<Deal> Deals { get; }
    DbSet<Task> Tasks { get; }
    DbSet<SupportTicket> SupportTickets { get; }
    DbSet<SupportTicketComment> SupportTicketComments { get; }
    DbSet<MarketingCampaign> MarketingCampaigns { get; }
    DbSet<MarketingCampaignActivity> MarketingCampaignActivities { get; }
    DbSet<User> Users { get; }
    
    Task<int> SaveChangesAsync(CancellationToken cancellationToken);
}

// src/UniversalbankCRM.Application/Common/Interfaces/ICurrentUserService.cs
namespace UniversalbankCRM.Application.Common.Interfaces;

public interface ICurrentUserService
{
    string? UserId { get; }
    string? Username { get; }
    bool IsAuthenticated { get; }
}

// src/UniversalbankCRM.Application/Common/Interfaces/IDateTimeService.cs
namespace UniversalbankCRM.Application.Common.Interfaces;

public interface IDateTimeService
{
    DateTime Now { get; }
}

// src/UniversalbankCRM.Application/Common/Models/Result.cs
namespace UniversalbankCRM.Application.Common.Models;

public class Result
{
    public bool Succeeded { get; set; }
    public string[] Errors { get; set; }

    internal Result(bool succeeded, IEnumerable<string> errors)
    {
        Succeeded = succeeded;
        Errors = errors.ToArray();
    }

    public static Result Success()
    {
        return new Result(true, Array.Empty<string>());
    }

    public static Result Failure(IEnumerable<string> errors)
    {
        return new Result(false, errors);
    }
}

public class Result<T> : Result
{
    public T Data { get; set; }

    private Result(T data, bool succeeded, IEnumerable<string> errors)
        : base(succeeded, errors)
    {
        Data = data;
    }

    public static Result<T> Success(T data)
    {
        return new Result<T>(data, true, Array.Empty<string>());
    }

    public new static Result<T> Failure(IEnumerable<string> errors)
    {
        return new Result<T>(default!, false, errors);
    }
}

// src/UniversalbankCRM.Application/Common/Behaviors/ValidationBehavior.cs
namespace UniversalbankCRM.Application.Common.Behaviors;

using System.Collections.Generic;
using System.Linq;
using System.Threading;
using System.Threading.Tasks;
using FluentValidation;
using MediatR;

public class ValidationBehavior<TRequest, TResponse> : IPipelineBehavior<TRequest, TResponse>
    where TRequest : notnull
{
    private readonly IEnumerable<IValidator<TRequest>> _validators;

    public ValidationBehavior(IEnumerable<IValidator<TRequest>> validators)
    {
        _validators = validators;
    }

    public async Task<TResponse> Handle(TRequest request, RequestHandlerDelegate<TResponse> next, CancellationToken cancellationToken)
    {
        if (_validators.Any())
        {
            var context = new ValidationContext<TRequest>(request);

            var validationResults = await Task.WhenAll(
                _validators.Select(v => v.ValidateAsync(context, cancellationToken)));

            var failures = validationResults
                .SelectMany(r => r.Errors)
                .Where(f => f != null)
                .ToList();

            if (failures.Count != 0)
                throw new ValidationException(failures);
        }

        return await next();
    }
}

// src/UniversalbankCRM.Application/Customers/Commands/CreateCustomer/CreateCustomerCommand.cs
namespace UniversalbankCRM.Application.Customers.Commands.CreateCustomer;

using MediatR;
using UniversalbankCRM.Application.Common.Interfaces;
using UniversalbankCRM.Application.Common.Models;
using UniversalbankCRM.Domain.Entities;
using UniversalbankCRM.Domain.Enums;

public class CreateCustomerCommand : IRequest<Result<Guid>>
{
    public CustomerType Type { get; set; }
    public string Name { get; set; } = string.Empty;
    public string? TaxId { get; set; }
    public string? Email { get; set; }
    public string? Phone { get; set; }
    public string? Address { get; set; }
    public string? ContactPerson { get; set; }
    public DateTime? DateOfBirth { get; set; }
    public string? PassportData { get; set; }
    public CustomerSegment Segment { get; set; }
    public string? Notes { get; set; }
}

// src/UniversalbankCRM.Application/Customers/Commands/CreateCustomer/CreateCustomerCommandValidator.cs
namespace UniversalbankCRM.Application.Customers.Commands.CreateCustomer;

using FluentValidation;

public class CreateCustomerCommandValidator : AbstractValidator<CreateCustomerCommand>
{
    public CreateCustomerCommandValidator()
    {
        RuleFor(v => v.Name)
            .NotEmpty().WithMessage("Мижоз номи киритилиши керак.")
            .MaximumLength(200).WithMessage("Мижоз номи 200 белгидан ошмаслиги керак.");

        RuleFor(v => v.Email)
            .EmailAddress().WithMessage("Тўғри электрон почта манзили киритинг.")
            .When(v => !string.IsNullOrEmpty(v.Email));

        RuleFor(v => v.TaxId)
            .NotEmpty().WithMessage("СТИР/ЖШШИР киритилиши керак.")
            .When(v => v.Type == Domain.Enums.CustomerType.Juridical);

        RuleFor(v => v.ContactPerson)
            .NotEmpty().WithMessage("Алоқа шахси киритилиши керак.")
            .When(v => v.Type == Domain.Enums.CustomerType.Juridical);
    }
}

// src/UniversalbankCRM.Application/Customers/Commands/CreateCustomer/CreateCustomerCommandHandler.cs
namespace UniversalbankCRM.Application.Customers.Commands.CreateCustomer;

using System.Threading;
using System.Threading.Tasks;
using MediatR;
using UniversalbankCRM.Application.Common.Interfaces;
using UniversalbankCRM.Application.Common.Models;
using UniversalbankCRM.Domain.Entities;
using UniversalbankCRM.Domain.Enums;

public class CreateCustomerCommandHandler : IRequestHandler<CreateCustomerCommand, Result<Guid>>
{
    private readonly IApplicationDbContext _context;
    private readonly ICurrentUserService _currentUserService;
    private readonly IDateTimeService _dateTimeService;

    public CreateCustomerCommandHandler(
        IApplicationDbContext context,
        ICurrentUserService currentUserService,
        IDateTimeService dateTimeService)
    {
        _context = context;
        _currentUserService = currentUserService;
        _dateTimeService = dateTimeService;
    }

    public async Task<Result<Guid>> Handle(CreateCustomerCommand request, CancellationToken cancellationToken)
    {
        var entity = new Customer
        {
            Id = Guid.NewGuid(),
            Type = request.Type,
            Name = request.Name,
            TaxId = request.TaxId,
            Email = request.Email,
            Phone = request.Phone,
            Address = request.Address,
            ContactPerson = request.ContactPerson,
            DateOfBirth = request.DateOfBirth,
            PassportData = request.PassportData,
            Segment = request.Segment,
            Status = CustomerStatus.Active,
            Notes = request.Notes,
            CreatedBy = _currentUserService.UserId,
            CreatedAt = _dateTimeService.Now
        };

        _context.Customers.Add(entity);

        await _context.SaveChangesAsync(cancellationToken);

        return Result<Guid>.Success(entity.Id);
    }
}

// src/UniversalbankCRM.Application/Customers/Queries/GetCustomerDetails/GetCustomerDetailsQuery.cs
namespace UniversalbankCRM.Application.Customers.Queries.GetCustomerDetails;

using MediatR;
using UniversalbankCRM.Application.Common.Models;

public class GetCustomerDetailsQuery : IRequest<Result<CustomerDetailsDto>>
{
    public Guid Id { get; set; }
}

// src/UniversalbankCRM.Application/Customers/Queries/GetCustomerDetails/CustomerDetailsDto.cs
namespace UniversalbankCRM.Application.Customers.Queries.GetCustomerDetails;

using UniversalbankCRM.Domain.Enums;

public class CustomerDetailsDto
{
    public Guid Id { get; set; }
    public CustomerType Type { get; set; }
    public string Name { get; set; } = string.Empty;
    public string? TaxId { get; set; }
    public string? Email { get; set; }
    public string? Phone { get; set; }
    public string? Address { get; set; }
    public string? ContactPerson { get; set; }
    public DateTime? DateOfBirth { get; set; }
    public string? PassportData { get; set; }
    public CustomerSegment Segment { get; set; }
    public CustomerStatus Status { get; set; }
    public string? Notes { get; set; }
    public DateTime CreatedAt { get; set; }
    public string? CreatedBy { get; set; }
    public DateTime? LastModifiedAt { get; set; }
    public string? LastModifiedBy { get; set; }
    
    public ICollection<CustomerInteractionDto> RecentInteractions { get; set; } = new List<CustomerInteractionDto>();
    public ICollection<CustomerDealDto> Deals { get; set; } = new List<CustomerDealDto>();
    public ICollection<CustomerSupportTicketDto> SupportTickets { get; set; } = new List<CustomerSupportTicketDto>();
}

// src/UniversalbankCRM.Application/Customers/Queries/GetCustomerDetails/CustomerInteractionDto.cs
namespace UniversalbankCRM.Application.Customers.Queries.GetCustomerDetails;

using UniversalbankCRM.Domain.Enums;

public class CustomerInteractionDto
{
    public Guid Id { get; set; }
    public InteractionType Type { get; set; }
    public string Subject { get; set; } = string.Empty;
    public string Description { get; set; } = string.Empty;
    public DateTime InteractionDate { get; set; }
    public InteractionDirection Direction { get; set; }
    public InteractionStatus Status { get; set; }
}

// src/UniversalbankCRM.Application/Customers/Queries/GetCustomerDetails/CustomerDealDto.cs
namespace UniversalbankCRM.Application.Customers.Queries.GetCustomerDetails;

using UniversalbankCRM.Domain.Enums;

public class CustomerDealDto
{
    public Guid Id { get; set; }
    public string Title { get; set; } = string.Empty;
    public decimal Value { get; set; }
    public DealStage Stage { get; set; }
    public int SuccessProbability { get; set; }
    public DateTime? ExpectedCloseDate { get; set; }
    public DealStatus Status { get; set; }
}

// src/UniversalbankCRM.Application/Customers/Queries/GetCustomerDetails/CustomerSupportTicketDto.cs
namespace UniversalbankCRM.Application.Customers.Queries.GetCustomerDetails;

using UniversalbankCRM.Domain.Enums;

public class CustomerSupportTicketDto
{
    public Guid Id { get; set; }
    public string Title { get; set; } = string.Empty;
    public SupportTicketStatus Status { get; set; }
    public SupportTicketPriority Priority { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime? ResolvedAt { get; set; }
}

// src/UniversalbankCRM.Application/Customers/Queries/GetCustomerDetails/GetCustomerDetailsQueryHandler.cs
namespace UniversalbankCRM.Application.Customers.Queries.GetCustomerDetails;

using System.Threading;
using System.Threading.Tasks;
using AutoMapper;
using AutoMapper.QueryableExtensions;
using MediatR;
using Microsoft.EntityFrameworkCore;
using UniversalbankCRM.Application.Common.Interfaces;
using UniversalbankCRM.Application.Common.Models;

public class GetCustomerDetailsQueryHandler : IRequestHandler<GetCustomerDetailsQuery, Result<CustomerDetailsDto>>
{
    private readonly IApplicationDbContext _context;
    private readonly IMapper _mapper;

    public GetCustomerDetailsQueryHandler(IApplicationDbContext context, IMapper mapper)
    {
        _context = context;
        _mapper = mapper;
    }

    public async Task<Result<CustomerDetailsDto>> Handle(GetCustomerDetailsQuery request, CancellationToken cancellationToken)
    {
        var customer = await _context.Customers
            .Include(c => c.Interactions.OrderByDescending(i => i.InteractionDate).Take(5))
            .Include(c => c.Deals)
            .Include(c => c.SupportTickets)
            .FirstOrDefaultAsync(c => c.Id == request.Id && !c.IsDeleted, cancellationToken);

        if (customer == null)
        {
            return Result<CustomerDetailsDto>.Failure(new[] { "Мижоз топилмади." });
        }

        var customerDetailsDto = _mapper.Map<CustomerDetailsDto>(customer);

        return Result<CustomerDetailsDto>.Success(customerDetailsDto);
    }
}

// src/UniversalbankCRM.Application/Customers/Queries/GetCustomersList/GetCustomersListQuery.cs
namespace UniversalbankCRM.Application.Customers.Queries.GetCustomersList;

using MediatR;
using UniversalbankCRM.Application.Common.Models;
using UniversalbankCRM.Domain.Enums;

public class GetCustomersListQuery : IRequest<Result<CustomersListVm>>
{
    public string? SearchString { get; set; }
    public CustomerType? CustomerType { get; set; }
    public CustomerSegment? Segment { get; set; }
    public int PageNumber { get; set; } = 1;
    public int PageSize { get; set; } = 10;
}

// src/UniversalbankCRM.Application/Customers/Queries/GetCustomersList/CustomersListVm.cs
namespace UniversalbankCRM.Application.Customers.Queries.GetCustomersList;

public class CustomersListVm
{
    public ICollection<CustomerListDto> Customers { get; set; } = new List<CustomerListDto>();
    public int TotalCount { get; set; }
    public int PageNumber { get; set; }
    public int TotalPages { get; set; }
}

// src/UniversalbankCRM.Application/Customers/Queries/GetCustomersList/CustomerListDto.cs
namespace UniversalbankCRM.Application.Customers.Queries.GetCustomersList;

using UniversalbankCRM.Domain.Enums;

public class CustomerListDto
{
    public Guid Id { get; set; }
    public CustomerType Type { get; set; }
    public string Name { get; set; } = string.Empty;
    public string? TaxId { get; set; }
    public string? Email { get; set; }
    public string? Phone { get; set; }
    public CustomerSegment Segment { get; set; }
    public CustomerStatus Status { get; set; }
    public DateTime CreatedAt { get; set; }
}

// src/UniversalbankCRM.Application/Customers/Queries/GetCustomersList/GetCustomersListQueryHandler.cs
namespace UniversalbankCRM.Application.Customers.Queries.GetCustomersList;

using System.Linq;
using System.Threading;
using System.Threading.Tasks;
using AutoMapper;
using AutoMapper.QueryableExtensions;
using MediatR;
using Microsoft.EntityFrameworkCore;
using UniversalbankCRM.Application.Common.Interfaces;
using UniversalbankCRM.Application.Common.Models;

public class GetCustomersListQueryHandler : IRequestHandler<GetCustomersListQuery, Result<CustomersListVm>>
{
    private readonly IApplicationDbContext _context;
    private readonly IMapper _mapper;

    public GetCustomersListQueryHandler(IApplicationDbContext context, IMapper mapper)
    {
        _context = context;
        _mapper = mapper;
    }

    public async Task<Result<CustomersListVm>> Handle(GetCustomersListQuery request, CancellationToken cancellationToken)
    {
        var query = _context.Customers
            .Where(c => !c.IsDeleted);

        if (!string.IsNullOrEmpty(request.SearchString))
        {
            query = query.Where(c => 
                c.Name.Contains(request.SearchString) || 
                c.TaxId.Contains(request.SearchString) || 
                c.Email.Contains(request.SearchString) || 
                c.Phone.Contains(request.SearchString));
        }

        if (request.CustomerType.HasValue)
        {
            query = query.Where(c => c.Type == request.CustomerType.Value);
        }

        if (request.Segment.HasValue)
        {
            query = query.Where(c => c.Segment == request.Segment.Value);
        }

        var totalCount = await query.CountAsync(cancellationToken);
        var totalPages = (int)Math.Ceiling(totalCount / (double)request.PageSize);

        var customers = await query
            .OrderBy(c => c.Name)
            .Skip((request.PageNumber - 1) * request.PageSize)
            .Take(request.PageSize)
            .ProjectTo<CustomerListDto>(_mapper.ConfigurationProvider)
            .ToListAsync(cancellationToken);

        var vm = new CustomersListVm
        {
            Customers = customers,
            TotalCount = totalCount,
            PageNumber = request.PageNumber,
            TotalPages = totalPages
        };

        return Result<CustomersListVm>.Success(vm);
    }
}

// src/UniversalbankCRM.Application/Deals/Commands/CreateDeal/CreateDealCommand.cs
namespace UniversalbankCRM.Application.Deals.Commands.CreateDeal;

using MediatR;
using UniversalbankCRM.Application.Common.Models;
using UniversalbankCRM.Domain.Enums;

public class CreateDealCommand : IRequest<Result<Guid>>
{
    public string Title { get; set; } = string.Empty;
    public Guid CustomerId { get; set; }
    public Guid? AssignedToUserId { get; set; }
    public decimal Value { get; set; }
    public string Description { get; set; } = string.Empty;
    public DealStage Stage { get; set; }
    public int SuccessProbability { get; set; }
    public DateTime? ExpectedCloseDate { get; set; }
    public string? Source { get; set; }
    public string? Notes { get; set; }
}

// src/UniversalbankCRM.Application/ConfigureServices.cs
namespace UniversalbankCRM.Application;

using System.Reflection;
using FluentValidation;
using MediatR;
using Microsoft.Extensions.DependencyInjection;
using UniversalbankCRM.Application.Common.Behaviors;

public static class ConfigureServices
{
    public static IServiceCollection AddApplicationServices(this IServiceCollection services)
    {
        services.AddAutoMapper(Assembly.GetExecutingAssembly());
        services.AddValidatorsFromAssembly(Assembly.GetExecutingAssembly());
        services.AddMediatR(cfg => {
            cfg.RegisterServicesFromAssembly(Assembly.GetExecutingAssembly());
            cfg.AddBehavior(typeof(IPipelineBehavior<,>), typeof(ValidationBehavior<,>));
        });

        return services;
    }
}

// src/UniversalbankCRM.Infrastructure/UniversalbankCRM.Infrastructure.csproj
<Project Sdk="Microsoft.NET.Sdk">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <ImplicitUsings>enable</ImplicitUsings>
    <Nullable>enable</Nullable>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.AspNetCore.Authentication.JwtBearer" Version="8.0.0" />
    <PackageReference Include="Microsoft.AspNetCore.Identity.EntityFrameworkCore" Version="8.0.0" />
    <PackageReference Include="Microsoft.EntityFrameworkCore.SqlServer" Version="8.0.0" />
    <PackageReference Include="Microsoft.EntityFrameworkCore.Tools" Version="8.0.0" />
    <PackageReference Include="Npgsql.EntityFrameworkCore.PostgreSQL" Version="8.0.0" />
    <PackageReference Include="Serilog" Version="3.1.1" />
    <PackageReference Include="Serilog.AspNetCore" Version="8.0.0" />
    <PackageReference Include="Serilog.Sinks.Console" Version="5.0.1" />
    <PackageReference Include="Serilog.Sinks.File" Version="5.0.0" />
    <PackageReference Include="System.IdentityModel.Tokens.Jwt" Version="7.0.3" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\UniversalbankCRM.Application\UniversalbankCRM.Application.csproj" />
  </ItemGroup>

</Project>

// src/UniversalbankCRM.Infrastructure/Persistence/ApplicationDbContext.cs
namespace UniversalbankCRM.Infrastructure.Persistence;

using Microsoft.EntityFrameworkCore;
using System.Reflection;
using UniversalbankCRM.Application.Common.Interfaces;
using UniversalbankCRM.Domain.Common;
using UniversalbankCRM.Domain.Entities;

public class ApplicationDbContext : DbContext, IApplicationDbContext
{
    private readonly ICurrentUserService _currentUserService;
    private readonly IDateTimeService _dateTimeService;

    public ApplicationDbContext(
        DbContextOptions<ApplicationDbContext> options,
        ICurrentUserService currentUserService,
        IDateTimeService dateTimeService) : base(options)
    {
        _currentUserService = currentUserService;
        _dateTimeService = dateTimeService;
    }

    public DbSet<Customer> Customers => Set<Customer>();
    public DbSet<Interaction> Interactions => Set<Interaction>();
    public DbSet<Deal> Deals => Set<Deal>();
    public DbSet<Task> Tasks => Set<Task>();
    public DbSet<SupportTicket> SupportTickets => Set<SupportTicket>();
    public DbSet<SupportTicketComment> SupportTicketComments => Set<SupportTicketComment>();
    public DbSet<MarketingCampaign> MarketingCampaigns => Set<MarketingCampaign>();
    public DbSet<MarketingCampaignActivity> MarketingCampaignActivities => Set<MarketingCampaignActivity>();
    public DbSet<User> Users => Set<User>();

    protected override void OnModelCreating(ModelBuilder builder)
    {
        builder.ApplyConfigurationsFromAssembly(Assembly.GetExecutingAssembly());

        base.OnModelCreating(builder);
    }

    public override async Task<int> SaveChangesAsync(CancellationToken cancellationToken = default)
    {
        foreach (var entry in ChangeTracker.Entries<EntityBase>())
        {
            switch (entry.State)
            {
                case EntityState.Added:
                    entry.Entity.CreatedBy = _currentUserService.UserId;
                    entry.Entity.CreatedAt = _dateTimeService.Now;
                    break;

                case EntityState.Modified:
                    entry.Entity.LastModifiedBy = _currentUserService.UserId;
                    entry.Entity.LastModifiedAt = _dateTimeService.Now;
                    break;
            }
        }

        return await base.SaveChangesAsync(cancellationToken);
    }
}

// src/UniversalbankCRM.Infrastructure/Persistence/Configurations/CustomerConfiguration.cs
namespace UniversalbankCRM.Infrastructure.Persistence.Configurations;

using Microsoft.EntityFrameworkCore;
using Microsoft.EntityFrameworkCore.Metadata.Builders;
using UniversalbankCRM.Domain.Entities;

public class CustomerConfiguration : IEntityTypeConfiguration<Customer>
{
    public void Configure(EntityTypeBuilder<Customer> builder)
    {
        builder.Property(t => t.Name)
            .HasMaxLength(200)
            .IsRequired();

        builder.Property(t => t.TaxId)
            .HasMaxLength(20);

        builder.Property(t => t.Email)
            .HasMaxLength(100);

        builder.Property(t => t.Phone)
            .HasMaxLength(20);

        builder.Property(t => t.Address)
            .HasMaxLength(500);

        builder.Property(t => t.ContactPerson)
            .HasMaxLength(200);

        builder.Property(t => t.PassportData)
            .HasMaxLength(50);

        builder.Property(t => t.Notes)
            .HasMaxLength(1000);

        // Add soft delete query filter
        builder.HasQueryFilter(e => !e.IsDeleted);
    }
}

// src/UniversalbankCRM.Infrastructure/Services/DateTimeService.cs
namespace UniversalbankCRM.Infrastructure.Services;

using UniversalbankCRM.Application.Common.Interfaces;

public class DateTimeService : IDateTimeService
{
    public DateTime Now => DateTime.UtcNow;
}

// src/UniversalbankCRM.Infrastructure/ConfigureServices.cs
namespace UniversalbankCRM.Infrastructure;

using Microsoft.EntityFrameworkCore;
using Microsoft.Extensions.Configuration;
using Microsoft.Extensions.DependencyInjection;
using UniversalbankCRM.Application.Common.Interfaces;
using UniversalbankCRM.Infrastructure.Persistence;
using UniversalbankCRM.Infrastructure.Services;

public static class ConfigureServices
{
    public static IServiceCollection AddInfrastructureServices(this IServiceCollection services, IConfiguration configuration)
    {
        // Database provider selection based on configuration
        var useSqlServer = configuration.GetValue<bool>("UseSqlServer");
        
        if (useSqlServer)
        {
            services.AddDbContext<ApplicationDbContext>(options =>
                options.UseSqlServer(
                    configuration.GetConnectionString("DefaultConnection"),
                    b => b.MigrationsAssembly(typeof(ApplicationDbContext).Assembly.FullName)));
        }
        else
        {
            services.AddDbContext<ApplicationDbContext>(options =>
                options.UseNpgsql(
                    configuration.GetConnectionString("DefaultConnection"),
                    b => b.MigrationsAssembly(typeof(ApplicationDbContext).Assembly.FullName)));
        }

        services.AddScoped<IApplicationDbContext>(provider => provider.GetRequiredService<ApplicationDbContext>());

        services.AddTransient<IDateTimeService, DateTimeService>();

        return services;
    }
}

// src/UniversalbankCRM.WebApi/UniversalbankCRM.WebApi.csproj
<Project Sdk="Microsoft.NET.Sdk.Web">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
    <UserSecretsId>aspnet-UniversalbankCRM.WebApi-74FB11BF-5AAC-4935-95C0-A02D67689F05</UserSecretsId>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.AspNetCore.Authentication.JwtBearer" Version="8.0.0" />
    <PackageReference Include="Microsoft.AspNetCore.OpenApi" Version="8.0.0" />
    <PackageReference Include="Microsoft.EntityFrameworkCore.Design" Version="8.0.0">
      <PrivateAssets>all</PrivateAssets>
      <IncludeAssets>runtime; build; native; contentfiles; analyzers; buildtransitive</IncludeAssets>
    </PackageReference>
    <PackageReference Include="Swashbuckle.AspNetCore" Version="6.5.0" />
  </ItemGroup>

  <ItemGroup>
    <ProjectReference Include="..\UniversalbankCRM.Application\UniversalbankCRM.Application.csproj" />
    <ProjectReference Include="..\UniversalbankCRM.Infrastructure\UniversalbankCRM.Infrastructure.csproj" />
  </ItemGroup>

</Project>

// src/UniversalbankCRM.WebApi/Program.cs
using Microsoft.OpenApi.Models;
using Serilog;
using UniversalbankCRM.Application;
using UniversalbankCRM.Infrastructure;
using UniversalbankCRM.WebApi.Services;

var builder = WebApplication.CreateBuilder(args);

// Add logger
Log.Logger = new LoggerConfiguration()
    .WriteTo.Console()
    .WriteTo.File("logs/crm-.log", rollingInterval: RollingInterval.Day)
    .CreateLogger();

builder.Host.UseSerilog();

// Add services to the container
builder.Services.AddApplicationServices();
builder.Services.AddInfrastructureServices(builder.Configuration);

builder.Services.AddSingleton<ICurrentUserService, CurrentUserService>();
builder.Services.AddHttpContextAccessor();

builder.Services.AddControllers();

// Learn more about configuring Swagger/OpenAPI at https://aka.ms/aspnetcore/swashbuckle
builder.Services.AddEndpointsApiExplorer();
builder.Services.AddSwaggerGen(c =>
{
    c.SwaggerDoc("v1", new OpenApiInfo
    {
        Title = "АТБ Universalbank CRM API",
        Version = "v1",
        Description = "Universalbank мижозлар билан муносабатларни бошқариш тизими API"
    });
    
    c.AddSecurityDefinition("Bearer", new OpenApiSecurityScheme
    {
        Description = "JWT Authorization header using the Bearer scheme. Example: \"Authorization: Bearer {token}\"",
        Name = "Authorization",
        In = ParameterLocation.Header,
        Type = SecuritySchemeType.ApiKey,
        Scheme = "Bearer"
    });
    
    c.AddSecurityRequirement(new OpenApiSecurityRequirement
    {
        {
            new OpenApiSecurityScheme
            {
                Reference = new OpenApiReference
                {
                    Type = ReferenceType.SecurityScheme,
                    Id = "Bearer"
                }
            },
            new string[] {}
        }
    });
});

// Configure CORS
builder.Services.AddCors(options =>
{
    options.AddPolicy("AllowAllOrigins",
        builder =>
        {
            builder.AllowAnyOrigin()
                .AllowAnyMethod()
                .AllowAnyHeader();
        });
});

var app = builder.Build();

// Configure the HTTP request pipeline
if (app.Environment.IsDevelopment())
{
    app.UseSwagger();
    app.UseSwaggerUI();
}

app.UseHttpsRedirection();

app.UseCors("AllowAllOrigins");

app.UseAuthentication();
app.UseAuthorization();

app.MapControllers();

try
{
    Log.Information("Starting UniversalbankCRM API");
    app.Run();
}
catch (Exception ex)
{
    Log.Fatal(ex, "Host terminated unexpectedly");
}
finally
{
    Log.CloseAndFlush();
}

// src/UniversalbankCRM.WebApi/Services/CurrentUserService.cs
namespace UniversalbankCRM.WebApi.Services;

using System.Security.Claims;
using UniversalbankCRM.Application.Common.Interfaces;

public class CurrentUserService : ICurrentUserService
{
    private readonly IHttpContextAccessor _httpContextAccessor;

    public CurrentUserService(IHttpContextAccessor httpContextAccessor)
    {
        _httpContextAccessor = httpContextAccessor;
    }

    public string? UserId => _httpContextAccessor.HttpContext?.User?.FindFirstValue(ClaimTypes.NameIdentifier);
    
    public string? Username => _httpContextAccessor.HttpContext?.User?.FindFirstValue(ClaimTypes.Name);
    
    public bool IsAuthenticated => _httpContextAccessor.HttpContext?.User?.Identity?.IsAuthenticated ?? false;
}

// src/UniversalbankCRM.WebApi/Controllers/ApiControllerBase.cs
namespace UniversalbankCRM.WebApi.Controllers;

using MediatR;
using Microsoft.AspNetCore.Mvc;

[ApiController]
[Route("api/[controller]")]
public abstract class ApiControllerBase : ControllerBase
{
    private ISender _mediator = null!;

    protected ISender Mediator => _mediator ??= HttpContext.RequestServices.GetRequiredService<ISender>();
}

// src/UniversalbankCRM.WebApi/Controllers/CustomersController.cs
namespace UniversalbankCRM.WebApi.Controllers;

using Microsoft.AspNetCore.Mvc;
using UniversalbankCRM.Application.Customers.Commands.CreateCustomer;
using UniversalbankCRM.Application.Customers.Queries.GetCustomerDetails;
using UniversalbankCRM.Application.Customers.Queries.GetCustomersList;

[ApiController]
[Route("api/[controller]")]
public class CustomersController : ApiControllerBase
{
    [HttpGet]
    public async Task<ActionResult<CustomersListVm>> GetAll([FromQuery] GetCustomersListQuery query)
    {
        var result = await Mediator.Send(query);
        
        if (result.Succeeded)
        {
            return Ok(result.Data);
        }
        
        return BadRequest(result.Errors);
    }

    [HttpGet("{id}")]
    public async Task<ActionResult<CustomerDetailsDto>> Get(Guid id)
    {
        var result = await Mediator.Send(new GetCustomerDetailsQuery { Id = id });
        
        if (result.Succeeded)
        {
            return Ok(result.Data);
        }
        
        return NotFound(result.Errors);
    }

    [HttpPost]
    public async Task<ActionResult<Guid>> Create(CreateCustomerCommand command)
    {
        var result = await Mediator.Send(command);
        
        if (result.Succeeded)
        {
            return Ok(result.Data);
        }
        
        return BadRequest(result.Errors);
    }
}

// src/UniversalbankCRM.WebApi/appsettings.json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=localhost;Database=UniversalbankCRM;User Id=sa;Password=YourStrongPassword!;TrustServerCertificate=True"
  },
  "UseSqlServer": true,
  "Logging": {
    "LogLevel": {
      "Default": "Information",
      "Microsoft.AspNetCore": "Warning"
    }
  },
  "AllowedHosts": "*"
}

// src/UniversalbankCRM.Blazor/UniversalbankCRM.Blazor.csproj
<Project Sdk="Microsoft.NET.Sdk.BlazorWebAssembly">

  <PropertyGroup>
    <TargetFramework>net8.0</TargetFramework>
    <Nullable>enable</Nullable>
    <ImplicitUsings>enable</ImplicitUsings>
  </PropertyGroup>

  <ItemGroup>
    <PackageReference Include="Microsoft.AspNetCore.Components.WebAssembly" Version="8.0.0" />
    <PackageReference Include="Microsoft.AspNetCore.Components.WebAssembly.DevServer" Version="8.0.0" PrivateAssets="all" />
    <PackageReference Include="Microsoft.Extensions.Http" Version="8.0.0" />
    <PackageReference Include="MudBlazor" Version="6.11.0" />
  </ItemGroup>

</Project>

// src/UniversalbankCRM.Blazor/Program.cs
using Microsoft.AspNetCore.Components.Web;
using Microsoft.AspNetCore.Components.WebAssembly.Hosting;
using MudBlazor.Services;
using UniversalbankCRM.Blazor;
using UniversalbankCRM.Blazor.Services;

var builder = WebAssemblyHostBuilder.CreateDefault(args);
builder.RootComponents.Add<App>("#app");
builder.RootComponents.Add<HeadOutlet>("head::after");

builder.Services.AddScoped(sp => new HttpClient { BaseAddress = new Uri(builder.Configuration["ApiBaseUrl"] ?? builder.HostEnvironment.BaseAddress) });

builder.Services.AddScoped<ICustomerService, CustomerService>();
builder.Services.AddScoped<IAuthService, AuthService>();

builder.Services.AddMudServices();

await builder.Build().RunAsync();

// src/UniversalbankCRM.Blazor/wwwroot/index.html
<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>АТБ "Universalbank" CRM</title>
    <base href="/" />
    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700&display=swap" rel="stylesheet" />
    <link href="_content/MudBlazor/MudBlazor.min.css" rel="stylesheet" />
    <link href="UniversalbankCRM.Blazor.styles.css" rel="stylesheet" />
    <link href="css/app.css" rel="stylesheet" />
    <link rel="icon" type="image/png" href="favicon.png" />
</head>
<body>
    <div id="app">
        <div class="loading-container">
            <img src="images/universalbank-logo.jpg" alt="Universalbank Logo" class="loading-logo" />
            <div class="loading-progress"></div>
            <div class="loading-text">Юкланмоқда...</div>
        </div>
    </div>

    <div id="blazor-error-ui">
        Хатолик юз берди.
        <a href="" class="reload">Қайта юклаш</a>
        <a class="dismiss">🗙</a>
    </div>

    <script src="_framework/blazor.webassembly.js"></script>
    <script src="_content/MudBlazor/MudBlazor.min.js"></script>
</body>
</html>

// src/UniversalbankCRM.Blazor/wwwroot/css/app.css
html, body {
    font-family: 'Roboto', Helvetica, Arial, sans-serif;
    margin: 0;
    padding: 0;
    height: 100%;
}

#app {
    height: 100%;
}

.loading-container {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    height: 100vh;
    background-color: #f5f5f5;
}

.loading-logo {
    width: 300px;
    margin-bottom: 20px;
}

.loading-progress {
    width: 300px;
    height: 4px;
    background-color: #e0e0e0;
    border-radius: 2px;
    overflow: hidden;
    position: relative;
}

.loading-progress::after {
    content: '';
    position: absolute;
    height: 100%;
    width: 30%;
    background-color: #af282e;
    animation: loading 1.5s infinite ease-in-out;
}

.loading-text {
    margin-top: 16px;
    color: #333;
    font-size: 16px;
}

@keyframes loading {
    0% {
        left: -30%;
    }
    100% {
        left: 100%;
    }
}

#blazor-error-ui {
    background-color: #ffffe0;
    bottom: 0;
    box-shadow: 0 -1px 2px rgba(0, 0, 0, 0.2);
    display: none;
    left: 0;
    padding: 0.6rem 1.25rem 0.7rem 1.25rem;
    position: fixed;
    width: 100%;
    z-index: 1000;
}

#blazor-error-ui .dismiss {
    cursor: pointer;
    position: absolute;
    right: 0.75rem;
    top: 0.5rem;
}

.mud-appbar {
    background-color: #af282e !important;
}

.mud-drawer {
    background-color: #1b294b !important;
}

.mud-drawer-header {
    background-color: #1b294b !important;
}

.universalbank-logo {
    max-height: 40px;
}

.menu-item-icon {
    color: #ffffff !important;
}

.menu-item-text {
    color: #ffffff !important;
}

.page-title {
    margin-bottom: 16px;
    color: #1b294b;
    font-weight: 500;
}

// src/UniversalbankCRM.Blazor/Services/ICustomerService.cs
namespace UniversalbankCRM.Blazor.Services;

using System.Collections.Generic;
using System.Threading.Tasks;
using UniversalbankCRM.Blazor.Models;

public interface ICustomerService
{
    Task<List<CustomerListDto>> GetCustomersAsync(string? searchString = null);
    Task<CustomerDetailsDto?> GetCustomerAsync(Guid id);
    Task<Guid> CreateCustomerAsync(CreateCustomerDto customer);
}

// src/UniversalbankCRM.Blazor/Services/CustomerService.cs
namespace UniversalbankCRM.Blazor.Services;

using System.Collections.Generic;
using System.Net.Http.Json;
using System.Threading.Tasks;
using UniversalbankCRM.Blazor.Models;

public class CustomerService : ICustomerService
{
    private readonly HttpClient _httpClient;

    public CustomerService(HttpClient httpClient)
    {
        _httpClient = httpClient;
    }

    public async Task<List<CustomerListDto>> GetCustomersAsync(string? searchString = null)
    {
        var url = "api/customers";
        if (!string.IsNullOrEmpty(searchString))
        {
            url += $"?searchString={Uri.EscapeDataString(searchString)}";
        }

        var response = await _httpClient.GetFromJsonAsync<CustomersListVm>(url);
        return response?.Customers?.ToList() ?? new List<CustomerListDto>();
    }

    public async Task<CustomerDetailsDto?> GetCustomerAsync(Guid id)
    {
        try
        {
            return await _httpClient.GetFromJsonAsync<CustomerDetailsDto>($"api/customers/{id}");
        }
        catch
        {
            return null;
        }
    }

    public async Task<Guid> CreateCustomerAsync(CreateCustomerDto customer)
    {
        var response = await _httpClient.PostAsJsonAsync("api/customers", customer);
        response.EnsureSuccessStatusCode();
        return await response.Content.ReadFromJsonAsync<Guid>();
    }
}

// src/UniversalbankCRM.Blazor/Services/IAuthService.cs
namespace UniversalbankCRM.Blazor.Services;

public interface IAuthService
{
    Task<bool> LoginAsync(string username, string password);
    Task LogoutAsync();
    Task<bool> IsAuthenticatedAsync();
}

// src/UniversalbankCRM.Blazor/Services/AuthService.cs
namespace UniversalbankCRM.Blazor.Services;

using System.Net.Http.Json;
using Microsoft.JSInterop;
using UniversalbankCRM.Blazor.Models;

public class AuthService : IAuthService
{
    private readonly HttpClient _httpClient;
    private readonly IJSRuntime _jsRuntime;

    public AuthService(HttpClient httpClient, IJSRuntime jsRuntime)
    {
        _httpClient = httpClient;
        _jsRuntime = jsRuntime;
    }

    public async Task<bool> LoginAsync(string username, string password)
    {
        var loginRequest = new LoginRequest
        {
            Username = username,
            Password = password
        };

        try
        {
            var response = await _httpClient.PostAsJsonAsync("api/auth/login", loginRequest);
            
            if (response.IsSuccessStatusCode)
            {
                var result = await response.Content.ReadFromJsonAsync<LoginResponse>();
                
                if (result is not null && !string.IsNullOrEmpty(result.Token))
                {
                    // Store token in local storage
                    await _jsRuntime.InvokeVoidAsync("localStorage.setItem", "authToken", result.Token);
                    
                    // Set the authorization header for subsequent requests
                    _httpClient.DefaultRequestHeaders.Authorization = 
                        new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", result.Token);
                    
                    return true;
                }
            }
            
            return false;
        }
        catch
        {
            return false;
        }
    }

    public async Task LogoutAsync()
    {
        await _jsRuntime.InvokeVoidAsync("localStorage.removeItem", "authToken");
        _httpClient.DefaultRequestHeaders.Authorization = null;
    }

    public async Task<bool> IsAuthenticatedAsync()
    {
        var token = await _jsRuntime.InvokeAsync<string>("localStorage.getItem", "authToken");
        
        if (!string.IsNullOrEmpty(token))
        {
            _httpClient.DefaultRequestHeaders.Authorization = 
                new System.Net.Http.Headers.AuthenticationHeaderValue("Bearer", token);
            return true;
        }
        
        return false;
    }
}

// src/UniversalbankCRM.Blazor/Models/CustomerListDto.cs
namespace UniversalbankCRM.Blazor.Models;

public class CustomerListDto
{
    public Guid Id { get; set; }
    public int Type { get; set; }
    public string Name { get; set; } = string.Empty;
    public string? TaxId { get; set; }
    public string? Email { get; set; }
    public string? Phone { get; set; }
    public int Segment { get; set; }
    public int Status { get; set; }
    public DateTime CreatedAt { get; set; }
    
    public string TypeText => Type switch
    {
        1 => "Жисмоний шахс",
        2 => "Юридик шахс",
        _ => "Номаълум"
    };
    
    public string SegmentText => Segment switch
    {
        1 => "Оддий",
        2 => "Премиум",
        3 => "VIP",
        4 => "Корпоратив",
        5 => "КХМ",
        _ => "Номаълум"
    };
    
    public string StatusText => Status switch
    {
        1 => "Актив",
        2 => "Пассив",
        3 => "Истиқболли",
        4 => "Собиқ",
        5 => "Қора рўйхатда",
        _ => "Номаълум"
    };
    
    public string StatusColor => Status switch
    {
        1 => "success",
        2 => "warning",
        3 => "info",
        4 => "dark",
        5 => "error",
        _ => "default"
    };
}

// src/UniversalbankCRM.Blazor/Models/CustomerDetailsDto.cs
namespace UniversalbankCRM.Blazor.Models;

public class CustomerDetailsDto
{
    public Guid Id { get; set; }
    public int Type { get; set; }
    public string Name { get; set; } = string.Empty;
    public string? TaxId { get; set; }
    public string? Email { get; set; }
    public string? Phone { get; set; }
    public string? Address { get; set; }
    public string? ContactPerson { get; set; }
    public DateTime? DateOfBirth { get; set; }
    public string? PassportData { get; set; }
    public int Segment { get; set; }
    public int Status { get; set; }
    public string? Notes { get; set; }
    public DateTime CreatedAt { get; set; }
    public string? CreatedBy { get; set; }
    public DateTime? LastModifiedAt { get; set; }
    public string? LastModifiedBy { get; set; }
    
    public List<CustomerInteractionDto> RecentInteractions { get; set; } = new();
    public List<CustomerDealDto> Deals { get; set; } = new();
    public List<CustomerSupportTicketDto> SupportTickets { get; set; } = new();
    
    public string TypeText => Type switch
    {
        1 => "Жисмоний шахс",
        2 => "Юридик шахс",
        _ => "Номаълум"
    };
    
    public string SegmentText => Segment switch
    {
        1 => "Оддий",
        2 => "Премиум",
        3 => "VIP",
        4 => "Корпоратив",
        5 => "КХМ",
        _ => "Номаълум"
    };
    
    public string StatusText => Status switch
    {
        1 => "Актив",
        2 => "Пассив",
        3 => "Истиқболли",
        4 => "Собиқ",
        5 => "Қора рўйхатда",
        _ => "Номаълум"
    };
    
    public string StatusColor => Status switch
    {
        1 => "success",
        2 => "warning",
        3 => "info",
        4 => "dark",
        5 => "error",
        _ => "default"
    };
}

// src/UniversalbankCRM.Blazor/Models/CustomerInteractionDto.cs
namespace UniversalbankCRM.Blazor.Models;

public class CustomerInteractionDto
{
    public Guid Id { get; set; }
    public int Type { get; set; }
    public string Subject { get; set; } = string.Empty;
    public string Description { get; set; } = string.Empty;
    public DateTime InteractionDate { get; set; }
    public int Direction { get; set; }
    public int Status { get; set; }
    
    public string TypeText => Type switch
    {
        1 => "Қўнғироқ",
        2 => "Электрон почта",
        3 => "Учрашув",
        4 => "Веб-форма",
        5 => "Ижтимоий тармоқ",
        6 => "Чат",
        7 => "Бошқа",
        _ => "Номаълум"
    };
    
    public string DirectionText => Direction switch
    {
        1 => "Кирувчи",
        2 => "Чиқувчи",
        _ => "Номаълум"
    };
    
    public string StatusText => Status switch
    {
        1 => "Режалаштирилган",
        2 => "Жараёнда",
        3 => "Тугалланган",
        4 => "Бекор қилинган",
        _ => "Номаълум"
    };
}

// src/UniversalbankCRM.Blazor/Models/CustomerDealDto.cs
namespace UniversalbankCRM.Blazor.Models;

public class CustomerDealDto
{
    public Guid Id { get; set; }
    public string Title { get; set; } = string.Empty;
    public decimal Value { get; set; }
    public int Stage { get; set; }
    public int SuccessProbability { get; set; }
    public DateTime? ExpectedCloseDate { get; set; }
    public int Status { get; set; }
    
    public string StageText => Stage switch
    {
        1 => "Лид",
        2 => "Малакали",
        3 => "Таклиф",
        4 => "Музокара",
        5 => "Ёпилган (ютуқ)",
        6 => "Ёпилган (йўқотиш)",
        _ => "Номаълум"
    };
    
    public string StatusText => Status switch
    {
        1 => "Актив",
        2 => "Кутишда",
        3 => "Ёпилган",
        4 => "Бекор қилинган",
        _ => "Номаълум"
    };
    
    public string StatusColor => Status switch
    {
        1 => "success",
        2 => "warning",
        3 => "info",
        4 => "error",
        _ => "default"
    };
}

// src/UniversalbankCRM.Blazor/Models/CustomerSupportTicketDto.cs
namespace UniversalbankCRM.Blazor.Models;

public class CustomerSupportTicketDto
{
    public Guid Id { get; set; }
    public string Title { get; set; } = string.Empty;
    public int Status { get; set; }
    public int Priority { get; set; }
    public DateTime CreatedAt { get; set; }
    public DateTime? ResolvedAt { get; set; }
    
    public string StatusText => Status switch
    {
        1 => "Янги",
        2 => "Тайинланган",
        3 => "Жараёнда",
        4 => "Мижоз жавобини кутмоқда",
        5 => "Ҳал қилинган",
        6 => "Ёпилган",
        7 => "Қайта очилган",
        _ => "Номаълум"
    };
    
    public string PriorityText => Priority switch
    {
        1 => "Паст",
        2 => "Ўрта",
        3 => "Юқори",
        4 => "Критик",
        _ => "Номаълум"
    };
    
    public string PriorityColor => Priority switch
    {
        1 => "success",
        2 => "info",
        3 => "warning",
        4 => "error",
        _ => "default"
    };
}

// src/UniversalbankCRM.Blazor/Models/CreateCustomerDto.cs
namespace UniversalbankCRM.Blazor.Models;

public class CreateCustomerDto
{
    public int Type { get; set; }
    public string Name { get; set; } = string.Empty;
    public string? TaxId { get; set; }
    public string? Email { get; set; }
    public string? Phone { get; set; }
    public string? Address { get; set; }
    public string? ContactPerson { get; set; }
    public DateTime? DateOfBirth { get; set; }
    public string? PassportData { get; set; }
    public int Segment { get; set; }
    public string? Notes { get; set; }
}

// src/UniversalbankCRM.Blazor/Models/CustomersListVm.cs
namespace UniversalbankCRM.Blazor.Models;

public class CustomersListVm
{
    public List<CustomerListDto> Customers { get; set; } = new();
    public int TotalCount { get; set; }
    public int PageNumber { get; set; }
    public int TotalPages { get; set; }
}

// src/UniversalbankCRM.Blazor/Models/LoginRequest.cs
namespace UniversalbankCRM.Blazor.Models;

public class LoginRequest
{
    public string Username { get; set; } = string.Empty;
    public string Password { get; set; } = string.Empty;
}

// src/UniversalbankCRM.Blazor/Models/LoginResponse.cs
namespace UniversalbankCRM.Blazor.Models;

public class LoginResponse
{
    public string Token { get; set; } = string.Empty;
    public string Username { get; set; } = string.Empty;
    public DateTime Expiration { get; set; }
}

// src/UniversalbankCRM.Blazor/App.razor
<Router AppAssembly="@typeof(App).Assembly">
    <Found Context="routeData">
        <RouteView RouteData="@routeData" DefaultLayout="@typeof(MainLayout)" />
        <FocusOnNavigate RouteData="@routeData" Selector="h1" />
    </Found>
    <NotFound>
        <PageTitle>Саҳифа топилмади</PageTitle>
        <LayoutView Layout="@typeof(MainLayout)">
            <MudText Typo="Typo.h4" Align="Align.Center" Class="my-4">404 - Саҳифа топилмади</MudText>
            <MudText Align="Align.Center">Кечирасиз, сиз изланаётган саҳифа мавжуд эмас.</MudText>
            <div class="d-flex justify-center mt-4">
                <MudButton Variant="Variant.Filled" Color="Color.Primary" Link="/">Бош саҳифага қайтиш</MudButton>
            </div>
        </LayoutView>
    </NotFound>
</Router>

// src/UniversalbankCRM.Blazor/Shared/MainLayout.razor
@inherits LayoutComponentBase

<MudThemeProvider Theme="_theme" />
<MudDialogProvider />
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="1">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@((e) => DrawerToggle())" />
        <MudImage Src="images/universalbank-logo.jpg" Alt="Universalbank Logo" Class="universalbank-logo mr-4" />
        <MudText Typo="Typo.h6">АТБ "Universalbank" CRM</MudText>
        <MudSpacer />
        <MudIconButton Icon="@Icons.Material.Filled.Notifications" Color="Color.Inherit" />
        <MudIconButton Icon="@Icons.Material.Filled.AccountCircle" Color="Color.Inherit" />
    </MudAppBar>
    <MudDrawer @bind-Open="_drawerOpen" Elevation="2">
        <MudNavMenu>
            <MudNavLink Href="/" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Dashboard">
                <MudIcon Icon="@Icons.Material.Filled.Dashboard" Class="menu-item-icon mr-2" />
                <span class="menu-item-text">Бош саҳифа</span>
            </MudNavLink>
            <MudNavLink Href="/customers" Match="NavLinkMatch.Prefix">
                <MudIcon Icon="@Icons.Material.Filled.People" Class="menu-item-icon mr-2" />
                <span class="menu-item-text">Мижозлар</span>
            </MudNavLink>
            <MudNavLink Href="/deals" Match="NavLinkMatch.Prefix">
                <MudIcon Icon="@Icons.Material.Filled.Paid" Class="menu-item-icon mr-2" />
                <span class="menu-item-text">Битимлар</span>
            </MudNavLink>
            <MudNavLink Href="/tasks" Match="NavLinkMatch.Prefix">
                <MudIcon Icon="@Icons.Material.Filled.Assignment" Class="menu-item-icon mr-2" />
                <span class="menu-item-text">Вазифалар</span>
            </MudNavLink>
            <MudNavLink Href="/support" Match="NavLinkMatch.Prefix">
                <MudIcon Icon="@Icons.Material.Filled.SupportAgent" Class="menu-item-icon mr-2" />
                <span class="menu-item-text">Қўллаб-қувватлаш</span>
            </MudNavLink>
            <MudNavLink Href="/marketing" Match="NavLinkMatch.Prefix">
                <MudIcon Icon="@Icons.Material.Filled.Campaign" Class="menu-item-icon mr-2" />
                <span class="menu-item-text">Маркетинг</span>
            </MudNavLink>
            <MudNavLink Href="/reports" Match="NavLinkMatch.Prefix">
                <MudIcon Icon="@Icons.Material.Filled.BarChart" Class="menu-item-icon mr-2" />
                <span class="menu-item-text">Ҳисоботлар</span>
            </MudNavLink>
            <MudNavLink Href="/settings" Match="NavLinkMatch.Prefix">
                <MudIcon Icon="@Icons.Material.Filled.Settings" Class="menu-item-icon mr-2" />
                <span class="menu-item-text">Созламалар</span>
            </MudNavLink>
        </MudNavMenu>
    </MudDrawer>
    <MudMainContent>
        <MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="py-4">
            @Body
        </MudContainer>
    </MudMainContent>
</MudLayout>

@code {
    private bool _drawerOpen = true;
    
    private MudTheme _theme = new()
    {
        Palette = new PaletteLight()
        {
            Primary = "#af282e",
            Secondary = "#1b294b",
            AppbarBackground = "#af282e",
            Background = "#f5f5f5",
            DrawerBackground = "#1b294b",
            DrawerText = "#ffffff",
            Surface = "#ffffff",
        }
    };

    private void DrawerToggle()
    {
        _drawerOpen = !_drawerOpen;
    }
}

// src/UniversalbankCRM.Blazor/Pages/Index.razor
@page "/"
@inject ICustomerService CustomerService

<PageTitle>Бош саҳифа - Universalbank CRM</PageTitle>

<MudText Typo="Typo.h4" Class="page-title">Бош саҳифа</MudText>

<MudGrid>
    <MudItem xs="12" sm="6" md="3">
        <MudPaper Class="d-flex flex-column pa-4" Elevation="2">
            <MudIcon Icon="@Icons.Material.Filled.People" Size="Size.Large" Color="Color.Primary" Class="mb-2" />
            <MudText Typo="Typo.h6">Мижозлар</MudText>
            <MudText Typo="Typo.body1">Жами: @_customerCount</MudText>
            <MudButton Variant="Variant.Text" Color="Color.Primary" Href="/customers">Батафсил</MudButton>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" sm="6" md="3">
        <MudPaper Class="d-flex flex-column pa-4" Elevation="2">
            <MudIcon Icon="@Icons.Material.Filled.Paid" Size="Size.Large" Color="Color.Secondary" Class="mb-2" />
            <MudText Typo="Typo.h6">Очиқ битимлар</MudText>
            <MudText Typo="Typo.body1">Жами: 12</MudText>
            <MudButton Variant="Variant.Text" Color="Color.Secondary" Href="/deals">Батафсил</MudButton>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" sm="6" md="3">
        <MudPaper Class="d-flex flex-column pa-4" Elevation="2">
            <MudIcon Icon="@Icons.Material.Filled.Assignment" Size="Size.Large" Color="Color.Info" Class="mb-2" />
            <MudText Typo="Typo.h6">Вазифалар</MudText>
            <MudText Typo="Typo.body1">Бугунги: 8</MudText>
            <MudButton Variant="Variant.Text" Color="Color.Info" Href="/tasks">Батафсил</MudButton>
        </MudPaper>
    </MudItem>
    <MudItem xs="12" sm="6" md="3">
        <MudPaper Class="d-flex flex-column pa-4" Elevation="2">
            <MudIcon Icon="@Icons.Material.Filled.SupportAgent" Size="Size.Large" Color="Color.Error" Class="mb-2" />
            <MudText Typo="Typo.h6">Мурожаатлар</MudText>
            <MudText Typo="Typo.body1">Янги: 5</MudText>
            <MudButton Variant="Variant.Text" Color="Color.Error" Href="/support">Батафсил</MudButton>
        </MudPaper>
    </MudItem>
</MudGrid>

<MudDivider Class="my-6" />

<MudGrid>
    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-4">Охирги қўшилган мижозлар</MudText>
            @if (_loading)
            {
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
            }
            else if (_customers.Any())
            {
                <MudTable Items="_customers.Take(5)" Hover="true" Breakpoint="Breakpoint.Sm">
                    <HeaderContent>
                        <MudTh>Ном</MudTh>
                        <MudTh>Тур</MudTh>
                        <MudTh>Сегмент</MudTh>
                        <MudTh>Сана</MudTh>
                        <MudTh></MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Ном">@context.Name</MudTd>
                        <MudTd DataLabel="Тур">@context.TypeText</MudTd>
                        <MudTd DataLabel="Сегмент">@context.SegmentText</MudTd>
                        <MudTd DataLabel="Сана">@context.CreatedAt.ToString("dd.MM.yyyy")</MudTd>
                        <MudTd>
                            <MudIconButton Icon="@Icons.Material.Filled.Visibility" 
                                          Size="Size.Small" 
                                          Color="Color.Primary"
                                          Href="@($"/customers/{context.Id}")" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            }
            else
            {
                <MudAlert Severity="Severity.Info">Мижозлар ҳали қўшилмаган</MudAlert>
            }
        </MudPaper>
    </MudItem>
    
    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-4">Битимлар статистикаси</MudText>
            <MudChart ChartType="ChartType.Pie" 
                     InputData="@_dealStats" 
                     InputLabels="@_dealLabels"
                     Width="300px"
                     Height="300px" />
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    private bool _loading = true;
    private int _customerCount = 0;
    private List<CustomerListDto> _customers = new();
    
    private double[] _dealStats = { 30, 15, 20, 25, 10 };
    private string[] _dealLabels = { "Лид", "Малакали", "Таклиф", "Музокара", "Ёпилган" };
    
    protected override async Task OnInitializedAsync()
    {
        try
        {
            _customers = await CustomerService.GetCustomersAsync();
            _customerCount = _customers.Count;
            _loading = false;
        }
        catch
        {
            _loading = false;
        }
    }
}Color.Error" Class="mb-2" />
            <MudText Typo="Typo.h6">Мурожаатлар</MudText>
            <MudText Typo="Typo.body1">Янги: 5</MudText>
            <MudButton Variant="Variant.Text" Color="Color.Error" Href="/support">Батафсил</MudButton>
        </MudPaper>
    </MudItem>
</MudGrid>

<MudDivider Class="my-6" />

<MudGrid>
    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-4">Охирги қўшилган мижозлар</MudText>
            @if (_loading)
            {
                <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
            }
            else if (_customers.Any())
            {
                <MudTable Items="_customers.Take(5)" Hover="true" Breakpoint="Breakpoint.Sm">
                    <HeaderContent>
                        <MudTh>Ном</MudTh>
                        <MudTh>Тур</MudTh>
                        <MudTh>Сегмент</MudTh>
                        <MudTh>Сана</MudTh>
                        <MudTh></MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="Ном">@context.Name</MudTd>
                        <MudTd DataLabel="Тур">@context.TypeText</MudTd>
                        <MudTd DataLabel="Сегмент">@context.SegmentText</MudTd>
                        <MudTd DataLabel="Сана">@context.CreatedAt.ToString("dd.MM.yyyy")</MudTd>
                        <MudTd>
                            <MudIconButton Icon="@Icons.Material.Filled.Visibility" 
                                          Size="Size.Small" 
                                          Color="Color.Primary"
                                          Href="@($"/customers/{context.Id}")" />
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            }
            else
            {
                <MudAlert Severity="Severity.Info">Мижозлар ҳали қўшилмаган</MudAlert>
            }
        </MudPaper>
    </MudItem>
    
    <MudItem xs="12" md="6">
        <MudPaper Class="pa-4" Elevation="2">
            <MudText Typo="Typo.h6" Class="mb-4">Битимлар статистикаси</MudText>
            <MudChart ChartType="ChartType.Pie" 
                     InputData="@_dealStats" 
                     InputLabels="@_dealLabels"
                     Width="300px"
                     Height="300px" />
        </MudPaper>
    </MudItem>
</MudGrid>

@code {
    private bool _loading = true;
    private int _customerCount = 0;
    private List<CustomerListDto> _customers = new();
    
    private double[] _dealStats = { 30, 15, 20, 25, 10 };
    private string[] _dealLabels = { "Лид", "Малакали", "Таклиф", "Музокара", "Ёпилган" };
    
    protected override async Task OnInitializedAsync()
    {
        try
        {
            _customers = await CustomerService.GetCustomersAsync();
            _customerCount = _customers.Count;
            _loading = false;
        }
        catch
        {
            _loading = false;
        }
    }
}

// src/UniversalbankCRM.Blazor/Pages/Customers/CustomersList.razor
@page "/customers"
@inject ICustomerService CustomerService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

<PageTitle>Мижозлар - Universalbank CRM</PageTitle>

<MudContainer MaxWidth="MaxWidth.False">
    <div class="d-flex justify-space-between align-center mb-4">
        <MudText Typo="Typo.h4" Class="page-title">Мижозлар</MudText>
        <MudButton Variant="Variant.Filled" 
                  Color="Color.Primary" 
                  StartIcon="@Icons.Material.Filled.Add"
                  Href="/customers/create">
            Мижоз қўшиш
        </MudButton>
    </div>
    
    <MudPaper Class="pa-4 mb-4" Elevation="2">
        <MudGrid>
            <MudItem xs="12" md="4">
                <MudTextField @bind-Value="_searchString" 
                             Label="Қидириш" 
                             Variant="Variant.Outlined"
                             Adornment="Adornment.End" 
                             AdornmentIcon="@Icons.Material.Filled.Search"
                             AdornmentColor="Color.Primary" 
                             OnAdornmentClick="SearchCustomers" />
            </MudItem>
            <MudItem xs="12" md="3">
                <MudSelect T="int?" @bind-Value="_selectedType" Label="Мижоз тури" Variant="Variant.Outlined">
                    <MudSelectItem Value="@null">Барчаси</MudSelectItem>
                    <MudSelectItem Value="1">Жисмоний шахс</MudSelectItem>
                    <MudSelectItem Value="2">Юридик шахс</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="3">
                <MudSelect T="int?" @bind-Value="_selectedSegment" Label="Сегмент" Variant="Variant.Outlined">
                    <MudSelectItem Value="@null">Барчаси</MudSelectItem>
                    <MudSelectItem Value="1">Оддий</MudSelectItem>
                    <MudSelectItem Value="2">Премиум</MudSelectItem>
                    <MudSelectItem Value="3">VIP</MudSelectItem>
                    <MudSelectItem Value="4">Корпоратив</MudSelectItem>
                    <MudSelectItem Value="5">КХМ</MudSelectItem>
                </MudSelect>
            </MudItem>
            <MudItem xs="12" md="2">
                <MudButton Variant="Variant.Filled" 
                          Color="Color.Primary" 
                          FullWidth="true"
                          OnClick="SearchCustomers"
                          Class="mt-2">
                    Қидириш
                </MudButton>
            </MudItem>
        </MudGrid>
    </MudPaper>
    
    @if (_loading)
    {
        <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
    }
    else if (_customers.Any())
    {
        <MudTable Items="_customers" 
                 Hover="true" 
                 Bordered="true" 
                 Striped="true" 
                 Breakpoint="Breakpoint.Sm"
                 Loading="@_loading"
                 LoadingProgressColor="Color.Primary">
            <HeaderContent>
                <MudTh>Ном</MudTh>
                <MudTh>Тур</MudTh>
                <MudTh>СТИР/ЖШШИР</MudTh>
                <MudTh>Телефон</MudTh>
                <MudTh>Email</MudTh>
                <MudTh>Сегмент</MudTh>
                <MudTh>Статус</MudTh>
                <MudTh>Амаллар</MudTh>
            </HeaderContent>
            <RowTemplate>
                <MudTd DataLabel="Ном">
                    <MudLink Href="@($"/customers/{context.Id}")">@context.Name</MudLink>
                </MudTd>
                <MudTd DataLabel="Тур">@context.TypeText</MudTd>
                <MudTd DataLabel="СТИР/ЖШШИР">@context.TaxId</MudTd>
                <MudTd DataLabel="Телефон">@context.Phone</MudTd>
                <MudTd DataLabel="Email">@context.Email</MudTd>
                <MudTd DataLabel="Сегмент">@context.SegmentText</MudTd>
                <MudTd DataLabel="Статус">
                    <MudChip Color="@GetStatusColor(context.Status)" Size="Size.Small">
                        @context.StatusText
                    </MudChip>
                </MudTd>
                <MudTd>
                    <MudIconButton Icon="@Icons.Material.Filled.Visibility" 
                                  Size="Size.Small" 
                                  Color="Color.Primary"
                                  Href="@($"/customers/{context.Id}")" />
                    <MudIconButton Icon="@Icons.Material.Filled.Edit" 
                                  Size="Size.Small" 
                                  Color="Color.Primary"
                                  Href="@($"/customers/edit/{context.Id}")" />
                </MudTd>
            </RowTemplate>
        </MudTable>
    }
    else
    {
        <MudAlert Severity="Severity.Info">Мижозлар топилмади</MudAlert>
    }
</MudContainer>

@code {
    private List<CustomerListDto> _customers = new();
    private bool _loading = true;
    private string _searchString = string.Empty;
    private int? _selectedType;
    private int? _selectedSegment;
    
    protected override async Task OnInitializedAsync()
    {
        await LoadCustomers();
    }
    
    private async Task LoadCustomers()
    {
        _loading = true;
        try
        {
            _customers = await CustomerService.GetCustomersAsync(_searchString);
            
            // Apply filters on client side (for demo purposes)
            if (_selectedType.HasValue)
            {
                _customers = _customers.Where(c => c.Type == _selectedType.Value).ToList();
            }
            
            if (_selectedSegment.HasValue)
            {
                _customers = _customers.Where(c => c.Segment == _selectedSegment.Value).ToList();
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add("Мижозлар рўйхатини юклашда хатолик юз берди", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }
    
    private async Task SearchCustomers()
    {
        await LoadCustomers();
    }
    
    private Color GetStatusColor(int status)
    {
        return status switch
        {
            1 => Color.Success,
            2 => Color.Warning,
            3 => Color.Info,
            4 => Color.Dark,
            5 => Color.Error,
            _ => Color.Default
        };
    }
}

// src/UniversalbankCRM.Blazor/Pages/Customers/CustomerDetails.razor
@page "/customers/{Id:guid}"
@inject ICustomerService CustomerService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

<PageTitle>Мижоз маълумотлари - Universalbank CRM</PageTitle>

@if (_loading)
{
    <MudProgressCircular Color="Color.Primary" Indeterminate="true" />
}
else if (_customer is null)
{
    <MudAlert Severity="Severity.Error">Мижоз топилмади</MudAlert>
    <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="GoBack" Class="mt-4">Орқага</MudButton>
}
else
{
    <MudContainer MaxWidth="MaxWidth.False">
        <div class="d-flex justify-space-between align-center mb-4">
            <div class="d-flex align-center">
                <MudText Typo="Typo.h4" Class="page-title">@_customer.Name</MudText>
                <MudChip Color="@(_customer.StatusColor)" Class="ml-4">@_customer.StatusText</MudChip>
            </div>
            <div>
                <MudButton Variant="Variant.Outlined" 
                          Color="Color.Primary" 
                          StartIcon="@Icons.Material.Filled.Edit"
                          Href="@($"/customers/edit/{_customer.Id}")">
                    Таҳрирлаш
                </MudButton>
                <MudButton Variant="Variant.Outlined"
                          Color="Color.Primary"
                          StartIcon="@Icons.Material.Filled.Add"
                          Href="@($"/deals/create?customerId={_customer.Id}")"
                          Class="ml-2">
                    Битим яратиш
                </MudButton>
            </div>
        </div>
        
        <MudGrid>
            <MudItem xs="12" md="4">
                <MudPaper Class="pa-4" Elevation="2">
                    <MudText Typo="Typo.h6" Class="mb-4">Асосий маълумотлар</MudText>
                    
                    <MudList Clickable="false">
                        <MudListItem>
                            <div class="d-flex">
                                <MudText Class="mr-2 font-weight-bold">Тур:</MudText>
                                <MudText>@_customer.TypeText</MudText>
                            </div>
                        </MudListItem>
                        <MudListItem>
                            <div class="d-flex">
                                <MudText Class="mr-2 font-weight-bold">СТИР/ЖШШИР:</MudText>
                                <MudText>@(_customer.TaxId ?? "—")</MudText>
                            </div>
                        </MudListItem>
                        <MudListItem>
                            <div class="d-flex">
                                <MudText Class="mr-2 font-weight-bold">Электрон почта:</MudText>
                                <MudText>@(_customer.Email ?? "—")</MudText>
                            </div>
                        </MudListItem>
                        <MudListItem>
                            <div class="d-flex">
                                <MudText Class="mr-2 font-weight-bold">Телефон:</MudText>
                                <MudText>@(_customer.Phone ?? "—")</MudText>
                            </div>
                        </MudListItem>
                        <MudListItem>
                            <div class="d-flex">
                                <MudText Class="mr-2 font-weight-bold">Манзил:</MudText>
                                <MudText>@(_customer.Address ?? "—")</MudText>
                            </div>
                        </MudListItem>
                        
                        @if (_customer.Type == 1) // Individual
                        {
                            <MudListItem>
                                <div class="d-flex">
                                    <MudText Class="mr-2 font-weight-bold">Туғилган сана:</MudText>
                                    <MudText>@(_customer.DateOfBirth?.ToString("dd.MM.yyyy") ?? "—")</MudText>
                                </div>
                            </MudListItem>
                            <MudListItem>
                                <div class="d-flex">
                                    <MudText Class="mr-2 font-weight-bold">Паспорт:</MudText>
                                    <MudText>@(_customer.PassportData ?? "—")</MudText>
                                </div>
                            </MudListItem>
                        }
                        else // Juridical
                        {
                            <MudListItem>
                                <div class="d-flex">
                                    <MudText Class="mr-2 font-weight-bold">Контакт шахс:</MudText>
                                    <MudText>@(_customer.ContactPerson ?? "—")</MudText>
                                </div>
                            </MudListItem>
                        }
                        
                        <MudListItem>
                            <div class="d-flex">
                                <MudText Class="mr-2 font-weight-bold">Сегмент:</MudText>
                                <MudText>@_customer.SegmentText</MudText>
                            </div>
                        </MudListItem>
                        <MudListItem>
                            <div class="d-flex">
                                <MudText Class="mr-2 font-weight-bold">Яратилган сана:</MudText>
                                <MudText>@_customer.CreatedAt.ToString("dd.MM.yyyy HH:mm")</MudText>
                            </div>
                        </MudListItem>
                    </MudList>
                </MudPaper>
                
                @if (!string.IsNullOrEmpty(_customer.Notes))
                {
                    <MudPaper Class="pa-4 mt-4" Elevation="2">
                        <MudText Typo="Typo.h6" Class="mb-2">Изоҳлар</MudText>
                        <MudText Typo="Typo.body1">@_customer.Notes</MudText>
                    </MudPaper>
                }
            </MudItem>
            
            <MudItem xs="12" md="8">
                <MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" PanelClass="pa-4">
                    <MudTabPanel Text="Битимлар" Icon="@Icons.Material.Filled.Paid">
                        @if (_customer.Deals.Any())
                        {
                            <MudTable Items="_customer.Deals" Hover="true" Breakpoint="Breakpoint.Sm">
                                <HeaderContent>
                                    <MudTh>Номи</MudTh>
                                    <MudTh>Қиймат</MudTh>
                                    <MudTh>Босқич</MudTh>
                                    <MudTh>Эҳтимол</MudTh>
                                    <MudTh>Кутилаётган сана</MudTh>
                                    <MudTh>Статус</MudTh>
                                    <MudTh></MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Номи">@context.Title</MudTd>
                                    <MudTd DataLabel="Қиймат">@context.Value.ToString("N0") сўм</MudTd>
                                    <MudTd DataLabel="Босқич">@context.StageText</MudTd>
                                    <MudTd DataLabel="Эҳтимол">@context.SuccessProbability%</MudTd>
                                    <MudTd DataLabel="Кутилаётган сана">@(context.ExpectedCloseDate?.ToString("dd.MM.yyyy") ?? "—")</MudTd>
                                    <MudTd DataLabel="Статус">
                                        <MudChip Color="@context.StatusColor" Size="Size.Small">
                                            @context.StatusText
                                        </MudChip>
                                    </MudTd>
                                    <MudTd>
                                        <MudIconButton Icon="@Icons.Material.Filled.Visibility" 
                                                      Size="Size.Small" 
                                                      Color="Color.Primary"
                                                      Href="@($"/deals/{context.Id}")" />
                                    </MudTd>
                                </RowTemplate>
                            </MudTable>
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Info">Битимлар мавжуд эмас</MudAlert>
                            <MudButton Variant="Variant.Filled" 
                                      Color="Color.Primary" 
                                      StartIcon="@Icons.Material.Filled.Add"
                                      Href="@($"/deals/create?customerId={_customer.Id}")"
                                      Class="mt-4">
                                Битим яратиш
                            </MudButton>
                        }
                    </MudTabPanel>
                    
                    <MudTabPanel Text="Ўзаро алоқалар" Icon="@Icons.Material.Filled.Forum">
                        @if (_customer.RecentInteractions.Any())
                        {
                            <MudTable Items="_customer.RecentInteractions" Hover="true" Breakpoint="Breakpoint.Sm">
                                <HeaderContent>
                                    <MudTh>Тур</MudTh>
                                    <MudTh>Мавзу</MudTh>
                                    <MudTh>Йўналиш</MudTh>
                                    <MudTh>Сана</MudTh>
                                    <MudTh>Статус</MudTh>
                                    <MudTh></MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Тур">@context.TypeText</MudTd>
                                    <MudTd DataLabel="Мавзу">@context.Subject</MudTd>
                                    <MudTd DataLabel="Йўналиш">@context.DirectionText</MudTd>
                                    <MudTd DataLabel="Сана">@context.InteractionDate.ToString("dd.MM.yyyy HH:mm")</MudTd>
                                    <MudTd DataLabel="Статус">@context.StatusText</MudTd>
                                    <MudTd>
                                        <MudIconButton Icon="@Icons.Material.Filled.Visibility" 
                                                      Size="Size.Small" 
                                                      Color="Color.Primary"
                                                      Href="@($"/interactions/{context.Id}")" />
                                    </MudTd>
                                </RowTemplate>
                            </MudTable>
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Info">Ўзаро алоқалар мавжуд эмас</MudAlert>
                            <MudButton Variant="Variant.Filled" 
                                      Color="Color.Primary" 
                                      StartIcon="@Icons.Material.Filled.Add"
                                      Href="@($"/interactions/create?customerId={_customer.Id}")"
                                      Class="mt-4">
                                Ўзаро алоқа қўшиш
                            </MudButton>
                        }
                    </MudTabPanel>
                    
                    <MudTabPanel Text="Мурожаатлар" Icon="@Icons.Material.Filled.SupportAgent">
                        @if (_customer.SupportTickets.Any())
                        {
                            <MudTable Items="_customer.SupportTickets" Hover="true" Breakpoint="Breakpoint.Sm">
                                <HeaderContent>
                                    <MudTh>Сарлавҳа</MudTh>
                                    <MudTh>Устувор</MudTh>
                                    <MudTh>Статус</MudTh>
                                    <MudTh>Яратилган</MudTh>
                                    <MudTh>Якунланган</MudTh>
                                    <MudTh></MudTh>
                                </HeaderContent>
                                <RowTemplate>
                                    <MudTd DataLabel="Сарлавҳа">@context.Title</MudTd>
                                    <MudTd DataLabel="Устувор">
                                        <MudChip Color="@context.PriorityColor" Size="Size.Small">
                                            @context.PriorityText
                                        </MudChip>
                                    </MudTd>
                                    <MudTd DataLabel="Статус">@context.StatusText</MudTd>
                                    <MudTd DataLabel="Яратилган">@context.CreatedAt.ToString("dd.MM.yyyy")</MudTd>
                                    <MudTd DataLabel="Якунланган">@(context.ResolvedAt?.ToString("dd.MM.yyyy") ?? "—")</MudTd>
                                    <MudTd>
                                        <MudIconButton Icon="@Icons.Material.Filled.Visibility" 
                                                      Size="Size.Small" 
                                                      Color="Color.Primary"
                                                      Href="@($"/support/{context.Id}")" />
                                    </MudTd>
                                </RowTemplate>
                            </MudTable>
                        }
                        else
                        {
                            <MudAlert Severity="Severity.Info">Мурожаатлар мавжуд эмас</MudAlert>
                            <MudButton Variant="Variant.Filled" 
                                      Color="Color.Primary" 
                                      StartIcon="@Icons.Material.Filled.Add"
                                      Href="@($"/support/create?customerId={_customer.Id}")"
                                      Class="mt-4">
                                Мурожаат яратиш
                            </MudButton>
                        }
                    </MudTabPanel>
                </MudTabs>
            </MudItem>
        </MudGrid>
    </MudContainer>
}

@code {
    [Parameter]
    public Guid Id { get; set; }
    
    private CustomerDetailsDto? _customer;
    private bool _loading = true;
    
    protected override async Task OnInitializedAsync()
    {
        await LoadCustomer();
    }
    
    private async Task LoadCustomer()
    {
        _loading = true;
        try
        {
            _customer = await CustomerService.GetCustomerAsync(Id);
            
            if (_customer is null)
            {
                Snackbar.Add("Мижоз топилмади", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add("Мижоз маълумотларини юклашда хатолик юз берди", Severity.Error);
        }
        finally
        {
            _loading = false;
        }
    }
    
    private void GoBack()
    {
        NavigationManager.NavigateTo("/customers");
    }
}

// src/UniversalbankCRM.Blazor/Pages/Customers/CreateCustomer.razor
@page "/customers/create"
@inject ICustomerService CustomerService
@inject ISnackbar Snackbar
@inject NavigationManager NavigationManager

<PageTitle>Янги мижоз - Universalbank CRM</PageTitle>

<MudContainer MaxWidth="MaxWidth.False">
    <div class="d-flex align-center mb-4">
        <MudText Typo="Typo.h4" Class="page-title">Янги мижоз қўшиш</MudText>
    </div>
    
    <MudPaper Class="pa-4" Elevation="2">
        <EditForm Model="@_model" OnValidSubmit="OnValidSubmit">
            <DataAnnotationsValidator />
            
            <MudGrid>
                <MudItem xs="12" md="6">
                    <MudSelect T="int" @bind-Value="_model.Type" Label="Мижоз тури" Required="true" Variant="Variant.Outlined" Class="mb-4">
                        <MudSelectItem Value="1">Жисмоний шахс</MudSelectItem>
                        <MudSelectItem Value="2">Юридик шахс</MudSelectItem>
                    </MudSelect>
                    
                    <MudTextField @bind-Value="_model.Name" 
                                 Label="Мижоз номи" 
                                 Variant="Variant.Outlined" 
                                 Required="true"
                                 HelperText="@(_model.Type == 1 ? "Ф.И.Ш." : "Ташкилот номи")"
                                 Class="mb-4" />
                    
                    <MudTextField @bind-Value="_model.TaxId" 
                                 Label="@(_model.Type == 1 ? "ЖШШИР" : "СТИР")" 
                                 Variant="Variant.Outlined" 
                                 Required="@(_model.Type == 2)"
                                 HelperText="@(_model.Type == 1 ? "14 рақамли ЖШШИР" : "9 рақамли СТИР")"
                                 Class="mb-4" />
                    
                    <MudTextField @bind-Value="_model.Email" 
                                 Label="Электрон почта" 
                                 Variant="Variant.Outlined" 
                                 HelperText="example@example.com"
                                 Class="mb-4" />
                    
                    <MudTextField @bind-Value="_model.Phone" 
                                 Label="Телефон" 
                                 Variant="Variant.Outlined" 
                                 HelperText="+998XXXXXXXXX"
                                 Class="mb-4" />
                    
                    <MudTextField @bind-Value="_model.Address" 
                                 Label="Манзил" 
                                 Variant="Variant.Outlined" 
                                 Lines="3"
                                 Class="mb-4" />
                </MudItem>
                
                <MudItem xs="12" md="6">
                    @if (_model.Type == 1) // Individual
                    {
                        <MudDatePicker @bind-Date="_dateOfBirth" 
                                      Label="Туғилган сана" 
                                      Variant="Variant.Outlined"
                                      Editable="true"
                                      Class="mb-4" />
                        
                        <MudTextField @bind-Value="_model.PassportData" 
                                     Label="Паспорт маълумотлари" 
                                     Variant="Variant.Outlined" 
                                     HelperText="Серия ва рақами"
                                     Class="mb-4" />
                    }
                    else // Juridical
                    {
                        <MudTextField @bind-Value="_model.ContactPerson" 
                                     Label="Алоқа шахси" 
                                     Variant="Variant.Outlined" 
                                     Required="true"
                                     HelperText="Ф.И.Ш."
                                     Class="mb-4" />
                    }
                    
                    <MudSelect T="int" @bind-Value="_model.Segment" Label="Сегмент" Required="true" Variant="Variant.Outlined" Class="mb-4">
                        <MudSelectItem Value="1">Оддий</MudSelectItem>
                        <MudSelectItem Value="2">Премиум</MudSelectItem>
                        <MudSelectItem Value="3">VIP</MudSelectItem>
                        <MudSelectItem Value="4">Корпоратив</MudSelectItem>
                        <MudSelectItem Value="5">КХМ</MudSelectItem>
                    </MudSelect>
                    
                    <MudTextField @bind-Value="_model.Notes" 
                                 Label="Изоҳлар" 
                                 Variant="Variant.Outlined" 
                                 Lines="5"
                                 Class="mb-4" />
                    
                    <MudDivider Class="mb-4" />
                    
                    <div class="d-flex justify-end">
                        <MudButton Variant="Variant.Outlined" 
                                  Color="Color.Secondary" 
                                  OnClick="GoBack"
                                  Class="mr-2">
                            Бекор қилиш
                        </MudButton>
                        <MudButton Variant="Variant.Filled" 
                                  Color="Color.Primary" 
                                  ButtonType="ButtonType.Submit"
                                  Disabled="@_processing">
                            Сақлаш
                        </MudButton>
                    </div>
                </MudItem>
            </MudGrid>
        </EditForm>
    </MudPaper>
</MudContainer>

@code {
    private CreateCustomerDto _model = new() { Type = 1, Segment = 1 };
    private DateTime? _dateOfBirth;
    private bool _processing = false;
    
    protected override void OnInitialized()
    {
        // Set default segment based on type (for demo purposes)
        _model.Segment = _model.Type == 1 ? 1 : 4;
    }
    
    private async Task OnValidSubmit()
    {
        _processing = true;
        
        try
        {
            // Map date to model
            if (_dateOfBirth.HasValue)
            {
                _model.DateOfBirth = _dateOfBirth.Value.Date;
            }
            
            var customerId = await CustomerService.CreateCustomerAsync(_model);
            
            Snackbar.Add("Мижоз муваффақиятли қўшилди", Severity.Success);
            NavigationManager.NavigateTo($"/customers/{customerId}");
        }
        catch (Exception ex)
        {
            Snackbar.Add("Мижоз яратишда хатолик юз берди", Severity.Error);
        }
        finally
        {
            _processing = false;
        }
    }
    
    private void GoBack()
    {
        NavigationManager.NavigateTo("/customers");
    }
}

// src/UniversalbankCRM.Blazor/wwwroot/appsettings.json
{
  "ApiBaseUrl": "https://localhost:7001"
}

// Ўрнатиш йўриқномаси
/*
# ATB "Universalbank" CRM Тизимини Ўрнатиш Йўриқномаси

## Талаблар
- .NET 8.0 SDK (ёки янгироқ версия)
- Visual Studio Code (ёки Visual Studio 2022)
- MS SQL Server (2019 ёки янгироқ) ёки PostgreSQL (14 ёки янгироқ)
- Git

## 1. Лойиҳани клонлаш

```bash
# Git репозиторийни клонлаш
git clone https://github.com/yourusername/universalbank-crm.git

# Лойиҳа папкасига кириш
cd universalbank-crm
```

## 2. Маълумотлар базасини созлаш

### MS SQL Server учун
- SQL Server Management Studio орқали янги маълумотлар базасини яратинг: `UniversalbankCRM`
- Маълумотлар базасига уланиш учун тегишли фойдаланувчи яратинг ёки Windows аутентификациясидан фойдаланинг

### PostgreSQL учун
- pgAdmin орқали янги маълумотлар базасини яратинг: `universalbank_crm`
- Маълумотлар базасига уланиш учун тегишли фойдаланувчи ва пароль созланг

## 3. Созлашларни ўзгартириш

`src/UniversalbankCRM.WebApi/appsettings.json` файлини очиб, маълумотлар базасига уланиш созламаларини ўзгартиринг:

### MS SQL Server учун
```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Server=YOUR_SERVER;Database=UniversalbankCRM;User Id=YOUR_USER;Password=YOUR_PASSWORD;TrustServerCertificate=True"
  },
  "UseSqlServer": true
}
```

### PostgreSQL учун
```json
{
  "ConnectionStrings": {
    "DefaultConnection": "Host=localhost;Database=universalbank_crm;Username=YOUR_USER;Password=YOUR_PASSWORD"
  },
  "UseSqlServer": false
}
```

## 4. Миграцияларни яратиш ва қўллаш

Терминал ёки командалар сатридан қуйидаги буйруқларни бажаринг:

```bash
# Лойиҳа папкасида
cd src/UniversalbankCRM.WebApi

# Янги миграция яратиш
dotnet ef migrations add InitialMigration -c ApplicationDbContext -p ../UniversalbankCRM.Infrastructure/UniversalbankCRM.Infrastructure.csproj

# Миграцияни маълумотлар базасига қўллаш
dotnet ef database update -c ApplicationDbContext -p ../UniversalbankCRM.Infrastructure/UniversalbankCRM.Infrastructure.csproj
```

## 5. Бэкенд (WebAPI) ни ишга тушириш

```bash
# Лойиҳа папкасида
cd src/UniversalbankCRM.WebApi

# Лойиҳани ишга тушириш
dotnet run
```

WebAPI https://localhost:7001 (ёки http://localhost:5001) манзилида ишга тушади.

## 6. Фронтенд (Blazor) ни ишга тушириш

Янги терминал ёки командалар сатрини очиб, қуйидаги буйруқларни бажаринг:

```bash
# Лойиҳа папкасида
cd src/UniversalbankCRM.Blazor

# Лойиҳани ишга тушириш
dotnet run
```

Blazor иловаси https://localhost:7002 (ёки http://localhost:5002) манзилида ишга тушади.

## 7. Тизимга кириш

Биринчи марта ишга тушгандан сўнг, тизимга киришингиз керак. Администратор ҳисоби созланмаган бўлса, қуйидаги маълумотларни ишлатинг:

- Фойдаланувчи номи: admin
- Парол: Admin123!

## 8. Ишлаб чиқариш муҳитига жойлаштириш

Ишлаб чиқариш муҳитига жойлаштириш учун:

### Бэкенд (WebAPI)

```bash
# Лойиҳа папкасида
cd src/UniversalbankCRM.WebApi

# Нашрга тайёрлаш
dotnet publish -c Release -o ./publish
```

### Фронтенд (Blazor)

```bash
# Лойиҳа папкасида
cd src/UniversalbankCRM.Blazor

# Нашрга тайёрлаш
dotnet publish -c Release -o ./publish
```

Ҳосил бўлган `publish` папкаларини веб-серверга нусхалаб қўйинг (IIS, Nginx, Apache ва ҳ.к.). Созлашларни ишлаб чиқариш муҳитига мос равишда ўзгартиринг.

## 9. Хавфсизлик тавсиялари

- Ишлаб чиқариш серверида кучли пароллардан фойдаланинг
- API ва фронтенд учун HTTPS ни фаоллаштиринг
- Маълумотлар базасининг мунтазам захира нусхаларини яратиб боринг
- SQL инъекциялар ва бошқа хавфсизлик заифликлари учун тизимни текшириб туринг

## 10. Қўллаб-қувватлаш

Техник қўллаб-қувватлаш ва ёрдам учун ИТ бўлимига мурожаат қилинг.
*/
